<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --card:#fff; --ink:#111; --muted:#6b7280;
      --brand:#101112; --accent:#f4c20d;
      --radius:14px; --gap:18px;
      --ring:32,33,36;
      --shadow-sm:0 1px 2px rgba(var(--ring), .08);
      --shadow-md:0 10px 25px rgba(var(--ring), .08), 0 2px 8px rgba(var(--ring), .06);
      --shadow-lg:0 30px 60px rgba(var(--ring), .14), 0 8px 20px rgba(var(--ring), .10);
    }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;color:var(--ink);background:#f6f7fb}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;height:auto;display:block}
    .wrap{max-width:1200px;margin:0 auto;padding:28px 18px 24px}
    .topbar{margin-bottom:12px}
    .back{display:inline-flex;gap:10px;align-items:center;color:#111;font-weight:500}
    .back::before{content:"←";opacity:.8}
    h1{margin:8px 0 6px;font-size:32px;letter-spacing:-.02em}
    .muted{color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 14px}
    .chip{background:#f6f6f6;border:1px solid #ececec;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip--accent{background:#fff7cf;border-color:#ffe899}

    /* --- Modern Grid Layout --- */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1fr) 360px;
      gap:26px;
      align-items:flex-start;
    }
    @media(max-width:980px){.layout{grid-template-columns:1fr}}
    .sticky{
      position:sticky;
      top:18px;
      align-self:start;
      display:flex;
      flex-direction:column;
      gap:18px;
      height:fit-content;
      max-height:calc(100vh - 40px);
      overflow-y:auto;
    }

    .hero-card{background:var(--card);border-radius:calc(var(--radius) + 4px);overflow:hidden;box-shadow:var(--shadow-lg)}
    .hero{position:relative;aspect-ratio:16/9;background:#eee;overflow:hidden}
    .hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .gallery{display:flex;gap:10px;padding:12px;overflow:auto;background:#fff}
    .thumb{flex:0 0 120px;aspect-ratio:4/3;border-radius:12px;overflow:hidden;border:1px solid #eee;cursor:pointer;transition:transform .12s ease}
    .thumb:hover{transform:translateY(-2px)}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow-md);border:1px solid #edf0f3;overflow:hidden}
    .card__body{padding:16px}
    .card__title{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);padding:12px 16px 8px;border-bottom:1px solid #f0f2f5;background:#fff}
    .actions{display:flex;gap:10px;margin-bottom:12px}
    .btn{height:44px;padding:0 16px;border-radius:10px;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-weight:600;text-decoration:none}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-primary::after{content:"";width:6px;height:6px;border-radius:999px;background:var(--accent);margin-left:8px}
    .btn-ghost{background:#fff;border:1px solid #e6e6e6}
    #map{height:260px;border-radius:12px;overflow:hidden;box-shadow:var(--shadow-sm)}
    .facts{display:grid;gap:14px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:700px){.facts{grid-template-columns:1fr}}
    .fact{background:#fff;border:1px solid #eef0f3;border-radius:12px;padding:14px;box-shadow:var(--shadow-sm)}
    .fact .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px}
    .fact .value{font-weight:600}
    .section{margin-top:22px}
    .features{margin:10px 0 2px;padding-left:20px}
    .features li{margin:6px 0}
    .agent{display:grid;grid-template-columns:48px 1fr;gap:12px;align-items:center;padding:12px 16px;border-top:1px solid #f0f2f5}
    .avatar{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#f1f3f6;color:#222;font-weight:700;border:1px solid #e9edf2}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar"><a class="back" href="index.html">Back to results</a></div>
    <div id="loading" class="muted">Loading…</div>
    <div id="content" style="display:none">
      <h1 id="prop-title">Property</h1>
      <div class="muted" id="prop-sub"></div>
      <div class="chips" id="prop-chips"></div>

      <div class="layout">
        <div>
          <div class="hero-card">
            <div class="hero" id="hero"></div>
            <div class="gallery" id="thumbs"></div>
          </div>

          <div class="section">
            <div class="card"><div class="card__title">Key details</div><div class="card__body"><div class="facts" id="facts"></div></div></div>
          </div>

          <div class="section" id="overviewCard" style="display:none">
            <div class="card"><div class="card__title"><h2>Overview</h2></div><div class="card__body" id="overview"></div></div>
          </div>

          <div class="section" id="featuresCard" style="display:none">
            <div class="card"><div class="card__title"><h2>Key features</h2></div><div class="card__body"><ul class="features" id="features"></ul></div></div>
          </div>

          <div class="section" id="descCard" style="display:none">
            <div class="card"><div class="card__title"><h2>Description</h2></div><div class="card__body" id="desc"></div></div>
          </div>
        </div>

        <aside class="sticky">
          <div class="card">
            <div class="card__title">Enquire about this property</div>
            <div class="card__body">
              <div class="actions">
                <button class="btn btn-primary" id="enquireBtn" type="button">Enquire now</button>
                <a class="btn btn-ghost" id="brochureBtn" target="_blank" rel="noopener">Download brochure</a>
              </div>
              <div id="map"></div>
            </div>
          </div>

          <div class="card" id="teamBox" style="display:none">
            <div class="card__title">Viewings & further information</div>
            <div id="agents"></div>
          </div>
        </aside>
      </div>
    </div>
  </div>
<script>
/* ==============================================
   Squarespace iframe-safe helpers (CLEAN)
============================================== */

if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

/* ---------- helpers ---------- */
const $ = (s, el=document) => el.querySelector(s);
const getParam = n => new URLSearchParams(location.search).get(n);
const pick = (...vals) => vals.find(v => v !== undefined && v !== null && v !== '');
const initials = n => n ? n.trim().split(/\s+/).slice(0,2).map(w=>w[0]?.toUpperCase()||'').join('') : '';

/* ---------- iframe height ---------- */
let lastHeight = 0;
let heightTimer = null;

function getPageHeight() {
  return Math.max(
    document.body.scrollHeight,
    document.documentElement.scrollHeight
  );
}

function notifyParentHeight() {
  const h = getPageHeight();
  if (Math.abs(h - lastHeight) < 8) return;
  lastHeight = h;
  try {
    window.parent?.postMessage({ type: 'gjs-prop-height', height: h }, '*');
  } catch(e){}
}

/* ---------- scroll to top ONCE ---------- */
let didScrollTop = false;
function scrollTopOnce() {
  if (didScrollTop) return;
  didScrollTop = true;
  window.scrollTo(0, 0);
  try {
    window.parent?.postMessage({ type: 'scroll-top' }, '*');
  } catch(e){}
}

/* ---------- main render ---------- */
async function main() {
  try {
    const id = getParam('id');
    const res = await fetch(
      'https://happydeskai.github.io/gjs-property-search/properties.json',
      { cache: 'no-store' }
    );
    const list = await res.json();
    const p = list.find(x => String(x.id) === String(id)) || list[0];
    if (!p) throw new Error('Property not found');

    $('#loading').style.display = 'none';
    $('#content').style.display = '';

    $('#prop-title').textContent = p.address || 'Property';
    $('#prop-sub').textContent = [p.town, p.postcode].filter(Boolean).join(' ');

    /* images */
    const imgs = (p.images || []).map(i => i.url || i).filter(Boolean);
    if (imgs[0]) $('#hero').innerHTML = `<img src="${imgs[0]}">`;
    $('#thumbs').innerHTML = imgs.map(u =>
      `<button class="thumb" data-src="${u}"><img src="${u}"></button>`
    ).join('');
    $('#thumbs').onclick = e => {
      const t = e.target.closest('.thumb');
      if (t) $('#hero').innerHTML = `<img src="${t.dataset.src}">`;
    };

    /* facts */
    const facts = [];
    if (p.size_from_sqft) facts.push(['Size', `${p.size_from_sqft.toLocaleString()} sq ft`]);
    if (p.epc) facts.push(['EPC', p.epc]);
    $('#facts').innerHTML = facts.map(f =>
      `<div class="fact"><div class="label">${f[0]}</div><div class="value">${f[1]}</div></div>`
    ).join('');

    if (p.description) {
      $('#desc').innerHTML = p.description;
      $('#descCard').style.display = '';
    }

    /* map */
    if (window.L && p.lat && p.lon) {
      const map = L.map('map').setView([p.lat, p.lon], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      L.marker([p.lat, p.lon]).addTo(map);
    }

    scrollTopOnce();
    notifyParentHeight();
    setTimeout(notifyParentHeight, 300);

    if ('ResizeObserver' in window) {
      const ro = new ResizeObserver(() => {
        clearTimeout(heightTimer);
        heightTimer = setTimeout(notifyParentHeight, 120);
      });
      ro.observe(document.getElementById('content'));
    }

  } catch (err) {
    console.error(err);
    $('#loading').textContent = 'Failed to load property';
  }
}

document.addEventListener('DOMContentLoaded', main);
</script>

<!-- Enquiry Modal -->
<div id="enquiryModal" class="modal" style="
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
  z-index:1000;backdrop-filter:blur(4px);
  align-items:flex-start;justify-content:center;
  padding-top:40px;padding:20px;">
  <div style="background:#fff;border-radius:16px;max-width:520px;width:100%;
              box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;
                padding:18px 22px;border-bottom:1px solid #eee;">
      <h2 style="margin:0;font-size:20px;">Enquire Now</h2>
      <button id="closeModal" style="border:none;background:none;font-size:22px;cursor:pointer;">×</button>
    </div>
    <div style="padding:22px;">
      <p id="propRefHint" style="font-size:13px;color:#555;margin:0 0 14px;"></p>
      <form id="enqForm">
        <label>First Name</label>
        <input type="text" id="firstName" style="width:100%;margin-bottom:8px;">
        <label>Last Name</label>
        <input type="text" id="lastName" style="width:100%;margin-bottom:8px;">
        <label>Email</label>
        <input type="email" id="email" style="width:100%;margin-bottom:8px;">
        <label>Phone</label>
        <input type="tel" id="phone" style="width:100%;margin-bottom:8px;">
        <label>Message</label>
        <textarea id="message" rows="3"
          style="width:100%;margin-bottom:14px;padding:8px;
                 border:1px solid #ccc;border-radius:6px;"></textarea>
        <button id="sendEnquiryBtn" type="submit"
          style="background:#101112;color:#fff;border:none;
                 padding:10px 16px;border-radius:8px;cursor:pointer;">
          Send Enquiry
        </button>
      </form>
    </div>
  </div>
</div>
</body>
</html>
