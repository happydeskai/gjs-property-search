<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --card:#fff; --ink:#111; --muted:#6b7280;
      --brand:#101112; --accent:#f4c20d;
      --radius:14px; --gap:18px;
      --ring:32,33,36;
      --shadow-sm:0 1px 2px rgba(var(--ring), .08);
      --shadow-md:0 10px 25px rgba(var(--ring), .08), 0 2px 8px rgba(var(--ring), .06);
      --shadow-lg:0 30px 60px rgba(var(--ring), .14), 0 8px 20px rgba(var(--ring), .10);
    }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;color:var(--ink);background:#f6f7fb}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;height:auto;display:block}
    .wrap{max-width:1200px;margin:0 auto;padding:28px 18px 24px}
    .topbar{margin-bottom:12px}
    .back{display:inline-flex;gap:10px;align-items:center;color:#111;font-weight:500}
    .back::before{content:"←";opacity:.8}
    h1{margin:8px 0 6px;font-size:32px;letter-spacing:-.02em}
    .muted{color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 14px}
    .chip{background:#f6f6f6;border:1px solid #ececec;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip--accent{background:#fff7cf;border-color:#ffe899}

    /* --- Modern Grid Layout --- */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1fr) 360px;
      gap:26px;
      align-items:flex-start;
    }
    @media(max-width:980px){.layout{grid-template-columns:1fr}}
    .sticky{
      position:sticky;
      top:18px;
      align-self:start;
      display:flex;
      flex-direction:column;
      gap:18px;
      height:fit-content;
      max-height:calc(100vh - 40px);
      overflow-y:auto;
    }

    .hero-card{background:var(--card);border-radius:calc(var(--radius) + 4px);overflow:hidden;box-shadow:var(--shadow-lg)}
    .hero{position:relative;aspect-ratio:16/9;background:#eee;overflow:hidden}
    .hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .gallery{display:flex;gap:10px;padding:12px;overflow:auto;background:#fff}
    .thumb{flex:0 0 120px;aspect-ratio:4/3;border-radius:12px;overflow:hidden;border:1px solid #eee;cursor:pointer;transition:transform .12s ease}
    .thumb:hover{transform:translateY(-2px)}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow-md);border:1px solid #edf0f3;overflow:hidden}
    .card__body{padding:16px}
    .card__title{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);padding:12px 16px 8px;border-bottom:1px solid #f0f2f5;background:#fff}
    .actions{display:flex;gap:10px;margin-bottom:12px}
    .btn{height:44px;padding:0 16px;border-radius:10px;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-weight:600;text-decoration:none}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-primary::after{content:"";width:6px;height:6px;border-radius:999px;background:var(--accent);margin-left:8px}
    .btn-ghost{background:#fff;border:1px solid #e6e6e6}
    #map{height:260px;border-radius:12px;overflow:hidden;box-shadow:var(--shadow-sm)}
    .facts{display:grid;gap:14px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:700px){.facts{grid-template-columns:1fr}}
    .fact{background:#fff;border:1px solid #eef0f3;border-radius:12px;padding:14px;box-shadow:var(--shadow-sm)}
    .fact .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px}
    .fact .value{font-weight:600}
    .section{margin-top:22px}
    .features{margin:10px 0 2px;padding-left:20px}
    .features li{margin:6px 0}
    .agent{display:grid;grid-template-columns:48px 1fr;gap:12px;align-items:center;padding:12px 16px;border-top:1px solid #f0f2f5}
    .avatar{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#f1f3f6;color:#222;font-weight:700;border:1px solid #e9edf2}

    /* Small sidebar agent card tweaks */
    #teamBox .agent { padding:12px; border-top:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar"><a class="back" href="index.html">Back to results</a></div>
    <div id="loading" class="muted">Loading…</div>
    <div id="content" style="display:none">
      <h1 id="prop-title">Property</h1>
      <div class="muted" id="prop-sub"></div>
      <div class="chips" id="prop-chips"></div>

      <div class="layout">
        <div>
          <div class="hero-card">
            <div class="hero" id="hero"></div>
            <div class="gallery" id="thumbs"></div>
          </div>

          <div class="section">
            <div class="card"><div class="card__title">Key details</div><div class="card__body"><div class="facts" id="facts"></div></div></div>
          </div>

          <div class="section" id="overviewCard" style="display:none">
            <div class="card"><div class="card__title"><h2>Overview</h2></div><div class="card__body" id="overview"></div></div>
          </div>

          <div class="section" id="featuresCard" style="display:none">
            <div class="card"><div class="card__title"><h2>Key features</h2></div><div class="card__body"><ul class="features" id="features"></ul></div></div>
          </div>

          <!-- Location card (shown only if JSON contains `location`) -->
          <div class="section" id="locationCard" style="display:none">
            <div class="card">
              <div class="card__title"><h2>Location</h2></div>
              <div class="card__body" id="location"></div>
            </div>
          </div>

          <div class="section" id="descCard" style="display:none">
            <div class="card"><div class="card__title"><h2>Description</h2></div><div class="card__body" id="desc"></div></div>
          </div>
        </div>

        <aside class="sticky">
          <div class="card">
            <div class="card__title">Enquire about this property</div>
            <div class="card__body">
              <div class="actions">
                <button class="btn btn-primary" id="enquireBtn" type="button">Enquire now</button>
                <a class="btn btn-ghost" id="brochureBtn" target="_blank" rel="noopener">Download brochure</a>
              </div>
              <div id="map"></div>
            </div>
          </div>

          <!-- Sidebar agents box (will be populated from `contacts` or `agents`) -->
          <div class="card" id="teamBox" style="display:none">
            <div class="card__title">Viewings & further information</div>
            <div id="agents"></div>
          </div>
        </aside>
      </div>
    </div>
  </div>
<script>
/* ==============================================
   Squarespace iframe-safe helpers (CLEAN)
============================================== */

if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

/* ---------- helpers ---------- */
const $ = (s, el=document) => el.querySelector(s);
const getParam = n => new URLSearchParams(location.search).get(n);
const pick = (...vals) => vals.find(v => v !== undefined && v !== null && v !== '');
const initials = n => n ? n.trim().split(/\s+/).slice(0,2).map(w=>w[0]?.toUpperCase()||'').join('') : '';

/* helper to check for http(s) URLs */
const isHttpUrl = s => typeof s === 'string' && (/^https?:\/\//i).test(s);

/* ---------- Robust iframe height reporting ---------- */
let lastHeight = 0;
let heightTimer = null;

function getPageHeight() {
  const body = document.body;
  const doc = document.documentElement;
  return Math.max(
    body.scrollHeight, doc.scrollHeight,
    body.offsetHeight, doc.offsetHeight,
    doc.clientHeight
  );
}

function notifyParentHeightImmediate() {
  try {
    const h = getPageHeight();
    if (Math.abs(h - lastHeight) < 6) return;
    lastHeight = h;
    window.parent?.postMessage({ type: 'gjs-prop-height', height: h }, '*');
  } catch (e){}
}

function notifyParentHeight() {
  clearTimeout(heightTimer);
  heightTimer = setTimeout(() => notifyParentHeightImmediate(), 40);
}

function scheduleHeightPings() {
  notifyParentHeight();
  setTimeout(notifyParentHeight, 120);
  setTimeout(notifyParentHeight, 350);
  setTimeout(notifyParentHeight, 900);
  setTimeout(notifyParentHeight, 2000);
}

function watchImages() {
  const imgs = Array.from(document.images || []);
  imgs.forEach(img => {
    if (img.complete) return;
    img.addEventListener('load', scheduleHeightPings, { once: true });
    img.addEventListener('error', scheduleHeightPings, { once: true });
  });
}

/* ---------- iframe scroll-to-top ---------- */
let didScrollTop = false;
function scrollTopOnce() {
  if (didScrollTop) return;
  didScrollTop = true;
  window.scrollTo(0, 0);
  try {
    window.parent?.postMessage({ type: 'scroll-top' }, '*');
  } catch(e){}
}

/* ---------- Safe DOM helpers ---------- */
function safeText(el, txt) { el.textContent = txt ?? ''; }
function createImg(src, alt) {
  const img = document.createElement('img');
  img.src = src;
  img.alt = alt || '';
  return img;
}

/* ---------- main render ---------- */
async function main() {
  try {
    const id = getParam('id');
    console.log('property main running, id=', id);
    const res = await fetch(
      'https://happydeskai.github.io/gjs-property-search/properties.json',
      { cache: 'no-store' }
    );
    if (!res.ok) throw new Error('Failed to fetch properties.json: ' + res.status);
    const list = await res.json();
    const p = list.find(x => String(x.id) === String(id)) || list[0];
    if (!p) throw new Error('Property not found');

    // --- Normalise common/legacy field names so the rest of the template can use stable keys
    p.agents = p.agents || p.contacts || [];
    p.brochure = p.brochure || p.brochure_url || p.brochureUrl || '';
    p.epc = p.epc || p.epc_rating || p.epcRating || '';
    p.rent_text = p.rent || (p.rent_psf ? (typeof p.rent_psf === 'number' ? `£${p.rent_psf.toLocaleString()} per sq ft` : String(p.rent_psf)) : '') || '';
    p.rateable_value = p.rateable_value || p.rateableValue || p.rateable || '';
    p.last_updated = p.last_updated || p.updated_at || p.lastUpdated || '';
    p.types = p.types || p.type || [];

    $('#loading').style.display = 'none';
    $('#content').style.display = '';

    $('#prop-title').textContent = p.address || 'Property';
    $('#prop-sub').textContent = [p.town, p.postcode].filter(Boolean).join(' ');

    /* images (use DOM methods to avoid accidental injection) */
    const imgs = (p.images || []).map(i => (typeof i === 'string' ? i : i.url)).filter(Boolean);
    const hero = $('#hero');
    hero.innerHTML = '';
    if (isHttpUrl(imgs[0])) {
      hero.appendChild(createImg(imgs[0], p.address || 'Property image'));
    }

    const thumbsEl = $('#thumbs');
    thumbsEl.innerHTML = '';
    imgs.forEach(u => {
      if (!isHttpUrl(u)) return;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'thumb';
      btn.dataset.src = u;
      btn.appendChild(createImg(u, p.address ? `Thumbnail for ${p.address}` : 'Thumbnail'));
      thumbsEl.appendChild(btn);
    });

    thumbsEl.addEventListener('click', (e) => {
      const t = e.target.closest('.thumb');
      if (t) {
        const src = t.dataset.src;
        if (isHttpUrl(src)) {
          hero.innerHTML = '';
          hero.appendChild(createImg(src, p.address || 'Property image'));
          scheduleHeightPings();
        }
      }
    });

    /* facts (build a richer facts array) */
    const facts = [];
    if (p.size_from_sqft) {
      const size = Number(p.size_from_sqft);
      facts.push(['Size', Number.isFinite(size) ? `${size.toLocaleString()} sq ft` : String(p.size_from_sqft)]);
    }
    if (p.epc) facts.push(['EPC', String(p.epc)]);
    if (p.rent_text) facts.push(['Rent', String(p.rent_text)]);
    if (p.rateable_value) facts.push(['Rateable value', String(p.rateable_value)]);
    if (p.last_updated) facts.push(['Updated', String(p.last_updated)]);
    if (p.types && p.types.length) facts.push(['Type', p.types.join(', ')]);

    const factsEl = $('#facts');
    factsEl.innerHTML = '';
    facts.forEach(([label, value]) => {
      const f = document.createElement('div');
      f.className = 'fact';
      const lab = document.createElement('div'); lab.className = 'label'; lab.textContent = label;
      const val = document.createElement('div'); val.className = 'value'; val.textContent = value;
      f.appendChild(lab); f.appendChild(val); factsEl.appendChild(f);
    });

    /* description */
    if (p.description) {
      // For safety we insert as textContent to avoid rendering untrusted HTML.
      // If you want to allow rich HTML, sanitize with a library (e.g. DOMPurify) before assigning to innerHTML.
      $('#desc').textContent = p.description;
      $('#descCard').style.display = '';
    } else {
      $('#descCard').style.display = 'none';
    }

    /* overview */
    if (p.overview) {
      $('#overview').textContent = p.overview;
      $('#overviewCard').style.display = '';
    } else {
      $('#overviewCard').style.display = 'none';
    }

    /* features */
    if (p.features && Array.isArray(p.features) && p.features.length) {
      const featuresEl = $('#features');
      featuresEl.innerHTML = '';
      p.features.forEach(fv => {
        const li = document.createElement('li'); li.textContent = fv; featuresEl.appendChild(li);
      });
      $('#featuresCard').style.display = '';
    } else {
      $('#featuresCard').style.display = 'none';
    }

    /* location (optional human readable location text in JSON) */
    if (p.location) {
      $('#location').textContent = p.location;
      $('#locationCard').style.display = '';
    } else {
      $('#locationCard') && ($('#locationCard').style.display = 'none');
    }

    /* brochure */
    const brochureBtn = $('#brochureBtn');
    if (p.brochure) {
      brochureBtn.href = p.brochure;
      brochureBtn.style.display = '';
    } else {
      brochureBtn.style.display = 'none';
    }

    /* agents (normalised from contacts) */
    if (p.agents && p.agents.length) {
      const agentsBox = document.getElementById('teamBox');
      const agentsEl = document.getElementById('agents');
      agentsEl.innerHTML = '';
      p.agents.forEach(a => {
        const div = document.createElement('div'); div.className = 'agent';
        const av = document.createElement('div'); av.className = 'avatar'; av.textContent = initials(a.name || '');
        const info = document.createElement('div');
        const name = document.createElement('div'); name.style.fontWeight = '600'; name.textContent = a.name || '';
        const contact = document.createElement('div'); contact.className = 'muted'; contact.textContent = a.phone || a.email || '';
        info.appendChild(name); info.appendChild(contact);
        div.appendChild(av); div.appendChild(info);
        agentsEl.appendChild(div);
      });
      agentsBox.style.display = '';
    } else {
      document.getElementById('teamBox').style.display = 'none';
    }

    /* map */
    let map = null;
    if (window.L && p.lat !== undefined && p.lon !== undefined && p.lat !== null && p.lon !== null) {
      try {
        map = L.map('map').setView([p.lat, p.lon], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        L.marker([p.lat, p.lon]).addTo(map);

        // Listen for tile load events to adjust height after map finishes rendering
        map.on && map.on('tileload', scheduleHeightPings);
        map.on && map.on('load', scheduleHeightPings);
      } catch (e) {
        console.warn('Leaflet map failed to initialize', e);
      }
    }

    // done rendering — ensure parent gets accurate height
    scrollTopOnce();
    scheduleHeightPings();

    // observe content for changes
    if ('ResizeObserver' in window) {
      const ro = new ResizeObserver(() => scheduleHeightPings());
      ro.observe(document.getElementById('content'));
    }

    // watch for images and other late layout shifts
    watchImages();

  } catch (err) {
    console.error(err);
    $('#loading').textContent = 'Failed to load property';
  }
}

document.addEventListener('DOMContentLoaded', main);
</script>

<!-- Modal CSS / Markup -->
<style>
  /* Ensure overlay is hidden by default and only visible when aria-hidden="false" */
  #enquiryModal[aria-hidden="true"]{
    display: none !important;
    pointer-events: none;
    opacity: 0;
  }
  #enquiryModal[aria-hidden="false"]{
    display: flex !important;
    pointer-events: auto;
    opacity: 1;
  }

  /* Modal backdrop & layout */
  #enquiryModal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(16,17,18,0.55);
    backdrop-filter: blur(4px);
    /* keep the flex fallback */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    height: 100vh;
  }

  /* Make the dialog fixed & slightly higher than true center */
  .modal__dialog {
    position: fixed;
    top: 45%;           /* moved up from 50% to sit slightly higher in viewport */
    left: 50%;
    transform: translate(-50%, -50%) scale(.995);
    width: 100%;
    max-width: 640px;
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 20px 50px rgba(16,17,18,0.35);
    overflow: hidden;
    transition: transform .18s ease, opacity .18s ease;
  }

  #enquiryModal[aria-hidden="false"] .modal__dialog {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  #enquiryModal[aria-hidden="true"] .modal__dialog {
    transform: translate(-50%, -46%) scale(.995);
    opacity: 0;
  }

  .modal__header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:18px 20px;
    border-bottom:1px solid #f0f1f3;
  }
  .modal__title {
    margin:0;
    font-size:18px;
    font-weight:700;
    color: #111;
  }
  .modal__close {
    background:transparent;border:none;font-size:20px;cursor:pointer;color:#555;
    padding:6px;border-radius:6px;
  }
  .modal__close:focus { outline:2px solid rgba(16,17,18,.12); }

  .modal__body { padding:18px 20px 22px; }

  .modal__hint { color:#666;font-size:13px;margin-bottom:12px; }

  /* Form styles */
  .modern-form { display:block; gap:12px; }
  .form-grid {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media(max-width:560px){ .form-grid {grid-template-columns:1fr} }

  label { display:block; font-size:13px; color:#333; margin-bottom:6px; }
  .input, textarea {
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #e6e8eb;
    background:#fff;
    font-size:15px;
    color:#111;
    box-shadow: inset 0 1px 2px rgba(16,17,18,0.03);
    transition:box-shadow .12s ease, border-color .12s ease, transform .08s ease;
  }
  .input:focus, textarea:focus {
    border-color: #101112;
    box-shadow: 0 4px 18px rgba(16,17,18,0.06);
    outline: none;
  }
  textarea { min-height:110px; resize:vertical; }

  .form-row { margin-bottom:8px; }

  .error {
    color: #b91c1c; font-size:13px; margin-top:6px;
  }

  .modal__actions {
    display:flex; gap:10px; margin-top:12px; align-items:center;
  }

  .btn {
    display:inline-flex; align-items:center; justify-content:center;
    border: none; cursor:pointer; padding:10px 14px; border-radius:10px;
    font-weight:700; font-size:14px;
  }
  .btn-primary {
    background: linear-gradient(180deg,#101112,#0b0b0b);
    color: #fff;
    box-shadow: 0 6px 18px rgba(16,17,18,0.12);
  }
  .btn-ghost {
    background:transparent;border:1px solid #e6e8eb;color:#222;padding:8px 12px;border-radius:10px;
  }
  .btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }

  /* spinner */
  .spinner {
    display:inline-block;
    width:16px;height:16px;border-radius:50%;
    border:2px solid rgba(255,255,255,.25);
    border-top-color: #fff;
    animation: spin .7s linear infinite;
    margin-left:8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* success message */
  .modal__success {
    padding: 18px 20px; text-align:center;
  }
  .modal__success h3 { margin:0 0 8px; font-size:16px; }
  .modal__success p { color:#444; font-size:14px; margin:0 0 12px; }
</style>

<div id="enquiryModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="enqTitle">
  <div class="modal__dialog" role="document">
    <div class="modal__header">
      <h2 id="enqTitle" class="modal__title">Enquire now</h2>
      <button class="modal__close" id="closeModal" aria-label="Close enquiry dialog">✕</button>
    </div>

    <div class="modal__body" id="enqBody">
      <p id="propRefHint" class="modal__hint"></p>

      <form id="enqForm" class="modern-form" novalidate>
        <div class="form-grid">
          <div class="form-row">
            <label for="firstNameInput">First name</label>
            <input id="firstNameInput" class="input" type="text" name="firstName" autocomplete="given-name" required>
            <div class="error" id="err-firstName" aria-live="polite" style="display:none"></div>
          </div>
          <div class="form-row">
            <label for="lastNameInput">Last name</label>
            <input id="lastNameInput" class="input" type="text" name="lastName" autocomplete="family-name" required>
            <div class="error" id="err-lastName" aria-live="polite" style="display:none"></div>
          </div>
        </div>

        <div class="form-grid" style="margin-top:6px;">
          <div class="form-row">
            <label for="emailInput">Email</label>
            <input id="emailInput" class="input" type="email" name="email" autocomplete="email" required>
            <div class="error" id="err-email" aria-live="polite" style="display:none"></div>
          </div>
          <div class="form-row">
            <label for="phoneInput">Phone</label>
            <input id="phoneInput" class="input" type="tel" name="phone" autocomplete="tel">
            <div class="error" id="err-phone" aria-live="polite" style="display:none"></div>
          </div>
        </div>

        <div class="form-row" style="margin-top:6px;">
          <label for="messageInput">Message</label>
          <textarea id="messageInput" class="input" name="message" placeholder="Optional message..."></textarea>
          <div class="error" id="err-message" aria-live="polite" style="display:none"></div>
        </div>

        <div class="modal__actions">
          <button id="sendEnquiryBtn" class="btn btn-primary" type="submit">
            Send enquiry
            <span id="enqSpinner" class="spinner" style="display:none"></span>
          </button>
          <button id="cancelEnquiryBtn" type="button" class="btn btn-ghost">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Success template (hidden until needed) -->
    <div id="enqSuccess" style="display:none;">
      <div class="modal__success">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="display:block;margin:0 auto 8px">
          <circle cx="12" cy="12" r="10" fill="#10B981"></circle>
          <path d="M7.5 12.2l2.6 2.6 6.4-6.4" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h3>Thanks — enquiry sent</h3>
        <p>We’ll get back to you shortly.</p>
        <div style="text-align:center"><button id="doneBtn" class="btn btn-primary">Done</button></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('enquiryModal');
  const dialog = modal.querySelector('.modal__dialog');
  const openBtn = document.getElementById('enquireBtn');
  const closeBtn = document.getElementById('closeModal');
  const cancelBtn = document.getElementById('cancelEnquiryBtn');
  const form = document.getElementById('enqForm');
  const spinner = document.getElementById('enqSpinner');
  const successBox = document.getElementById('enqSuccess');
  const bodyBox = document.getElementById('enqBody');
  const doneBtn = document.getElementById('doneBtn');
  const propRefHint = document.getElementById('propRefHint');

  // fields
  const fields = {
    firstName: document.getElementById('firstNameInput'),
    lastName: document.getElementById('lastNameInput'),
    email: document.getElementById('emailInput'),
    phone: document.getElementById('phoneInput'),
    message: document.getElementById('messageInput')
  };

  let lastFocusedEl = null;

  function showModal() {
    lastFocusedEl = document.activeElement;
    // lock background scroll so modal is centered in viewport
    try { document.documentElement.style.overflow = 'hidden'; document.body.style.overflow = 'hidden'; } catch(e){}
    modal.setAttribute('aria-hidden', 'false');
    scheduleHeightPings();

    const title = document.getElementById('prop-title')?.textContent?.trim();
    propRefHint.textContent = title ? `About: ${title}` : '';

    // reset & focus without scrolling the viewport
    form.reset();
    clearErrors();
    bodyBox.style.display = '';
    successBox.style.display = 'none';

    // Focus first input but prevent browser auto-scroll where supported.
    setTimeout(() => {
      try {
        fields.firstName.focus({ preventScroll: true });
      } catch (err) {
        // Fallback: save/restore scroll
        const sx = window.scrollX || window.pageXOffset;
        const sy = window.scrollY || window.pageYOffset;
        fields.firstName.focus();
        window.scrollTo(sx, sy);
      }
    }, 50);
  }
  function closeModal() {
    try { document.documentElement.style.overflow = ''; document.body.style.overflow = ''; } catch(e){}
    modal.setAttribute('aria-hidden', 'true');
    scheduleHeightPings();
    if (lastFocusedEl) lastFocusedEl.focus();
  }

  function setError(fieldName, message) {
    const el = document.getElementById('err-' + fieldName);
    if (!el) return;
    el.textContent = message || '';
    el.style.display = message ? '' : 'none';
  }
  function clearErrors() {
    setError('firstName',''); setError('lastName',''); setError('email',''); setError('phone',''); setError('message','');
  }

  function validate() {
    clearErrors();
    let ok = true;
    if (!fields.firstName.value.trim()) { setError('firstName','Please enter a first name'); ok = false;}
    if (!fields.lastName.value.trim()) { setError('lastName','Please enter a last name'); ok = false;}
    const em = fields.email.value.trim();
    if (!em) { setError('email','Please enter an email'); ok = false; }
    else if (!/^\S+@\S+\.\S+$/.test(em)) { setError('email','Please enter a valid email'); ok = false; }
    return ok;
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!validate()) return;
    // simulate send: show spinner, disable button
    document.getElementById('sendEnquiryBtn').disabled = true;
    spinner.style.display = '';
    // TODO: replace with real fetch to your API
    setTimeout(() => {
      spinner.style.display = 'none';
      document.getElementById('sendEnquiryBtn').disabled = false;
      // show success UI
      bodyBox.style.display = 'none';
      successBox.style.display = '';
      scheduleHeightPings();
    }, 900);
  });

  // Open/close wiring
  openBtn && openBtn.addEventListener('click', showModal);
  closeBtn && closeBtn.addEventListener('click', closeModal);
  cancelBtn && cancelBtn.addEventListener('click', closeModal);
  doneBtn && doneBtn.addEventListener('click', closeModal);

  // click outside to close
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // ESC key
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

  // Simple focus trap (keeps focus inside dialog)
  modal.addEventListener('keydown', (e) => {
    if (e.key !== 'Tab') return;
    const focusables = dialog.querySelectorAll('a[href], button:not([disabled]), textarea, input, select');
    if (focusables.length === 0) return;
    const first = focusables[0];
    const last = focusables[focusables.length - 1];
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault(); last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault(); first.focus();
    }
  });

  // expose for dev/debug if needed
  window.__enquiryModal = { show: showModal, close: closeModal };
})();
</script>
</body>
</html>
