<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ---------- tokens ---------- */
    :root{
      --card:#fff; --ink:#111; --muted:#6b7280;
      --brand:#101112;               /* primary/dark */
      --accent:#f4c20d;              /* GJS yellow hint */
      --radius:14px; --gap:18px;
      --ring:32,33,36;
      --shadow-sm:0 1px 2px rgba(var(--ring), .08);
      --shadow-md:0 10px 25px rgba(var(--ring), .08), 0 2px 8px rgba(var(--ring), .06);
      --shadow-lg:0 30px 60px rgba(var(--ring), .14), 0 8px 20px rgba(var(--ring), .10);
    }

    /* ---------- base ---------- */
    *,*::before,*::after{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 20% -10%, #e9eefc 0%, transparent 60%),
        radial-gradient(1200px 600px at 100% 0%, #eaf7ff 0%, transparent 55%),
        #f6f7fb;
    }
    a{color:inherit}

    .wrap{max-width:1200px;margin:0 auto;padding:28px 18px 72px}
    .topbar{margin-bottom:12px}
    .back{display:inline-flex;gap:10px;align-items:center;text-decoration:none;color:#111}
    .back::before{content:"←";opacity:.8}
    h1{margin:8px 0 6px;font-size:32px;letter-spacing:-.02em}
    .muted{color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 14px}
    .chip{background:#f6f6f6;border:1px solid #ececec;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip--accent{background:#fff7cf;border-color:#ffe899}

    /* ---------- layout ---------- */
    .layout{display:grid;grid-template-columns:minmax(0,1fr) 360px;gap:26px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}

    /* ---------- hero / gallery ---------- */
    .hero-card{background:var(--card);border-radius:calc(var(--radius) + 4px);overflow:hidden;box-shadow:var(--shadow-lg)}
    .hero{position:relative;aspect-ratio:16/9;background:#eee;overflow:hidden}
    .hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .hero::after{content:"";position:absolute;inset:0;background:linear-gradient(to top, rgba(0,0,0,.18), transparent 40%);pointer-events:none}
    .gallery{display:flex;gap:10px;padding:12px 12px 16px;overflow:auto;background:linear-gradient(#fff,#fff)}
    .thumb{flex:0 0 120px;aspect-ratio:4/3;border-radius:12px;overflow:hidden;border:1px solid #eee;box-shadow:var(--shadow-sm);background:#f3f3f3;cursor:pointer;transition:transform .12s ease}
    .thumb:hover{transform:translateY(-2px)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}

    /* ---------- sticky aside ---------- */
    .sticky{position:sticky;top:18px;align-self:start;display:flex;flex-direction:column;gap:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow-md);border:1px solid #edf0f3;overflow:hidden}
    .card__body{padding:16px}
    .card__title{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);padding:12px 16px 8px;border-bottom:1px solid #f0f2f5;background:linear-gradient(#fff,#fff)}
    .actions{display:flex;gap:10px;margin-bottom:12px}
    .btn{height:44px;padding:0 16px;border-radius:10px;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-weight:600;text-decoration:none;box-shadow:var(--shadow-sm)}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-primary::after{content:"";width:6px;height:6px;border-radius:999px;background:var(--accent);margin-left:8px}
    .btn-ghost{background:#fff;border:1px solid #e6e6e6}
    #map{height:260px;border-radius:12px;overflow:hidden;box-shadow:var(--shadow-sm)}

    /* ---------- facts ---------- */
    .facts{display:grid;gap:14px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:700px){.facts{grid-template-columns:1fr}}
    .fact{background:#fff;border:1px solid #eef0f3;border-radius:12px;padding:14px;box-shadow:var(--shadow-sm)}
    .fact .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px}
    .fact .value{font-weight:600}

    /* ---------- sections ---------- */
    .section{margin-top:22px}
    .section .card__title{display:flex;align-items:center;gap:8px}
    .section h2{font-size:18px;margin:0;letter-spacing:-.01em}
    .features{margin:10px 0 2px;padding-left:20px}
    .features li{margin:6px 0}

    /* ---------- agents ---------- */
    .agent{display:grid;grid-template-columns:48px 1fr;gap:12px;align-items:center;padding:12px 16px;border-top:1px solid #f0f2f5}
    .agent:first-of-type{border-top:none}
    .avatar{width:48px;height:48px;border-radius:50%;overflow:hidden;display:grid;place-items:center;background:#f1f3f6;color:#222;font-weight:700;border:1px solid #e9edf2}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .agent .name{font-weight:600}
    .agent .meta{font-size:13px;color:var(--muted)}
    .agent .cta{margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
    .agent .cta a{font-size:13px;text-decoration:underline}

    /* ---------- modal (compact) ---------- */
    .modal{position:fixed;inset:0;display:none}
    .modal.open{display:block}
    .modal__backdrop{position:absolute;inset:0;background:rgba(16,17,18,.46);backdrop-filter:blur(2px)}
    .modal__panel{
      position:relative;max-width:760px;margin:6vh auto;background:#fff;border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;border:1px solid #eef1f4
    }
    @media (max-width:820px){ .modal__panel{ margin:2vh 14px } }
    .modal__head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef1f4}
    .modal__title{font-weight:700;letter-spacing:-.01em;font-size:16px}
    .modal__close{border:none;background:#fff;width:34px;height:34px;border-radius:10px;display:grid;place-items:center;cursor:pointer;border:1px solid #eceff3}
    .modal__body{padding:14px}
    .pillbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px}
    .contact-pill{
      display:grid;grid-template-columns:34px 1fr;gap:8px;align-items:center;border:1px solid #eceff3;background:#fff;border-radius:12px;padding:8px 10px;
    }
    .pill-avatar{width:34px;height:34px;border-radius:50%;overflow:hidden;background:#f2f4f7;display:grid;place-items:center;font-weight:700;border:1px solid #e8edf2}
    .pill-avatar img{width:100%;height:100%;object-fit:cover}
    .pill-name{font-weight:600;font-size:14px}
    .pill-meta{font-size:12px;color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:740px){ .grid2{grid-template-columns:1fr} }
    .f{display:flex;flex-direction:column;gap:4px}
    .f label{font-size:12px;color:var(--muted)}
    .f input,.f select,.f textarea{
      height:42px;padding:9px 11px;border-radius:10px;border:1px solid #dfe3e9;font-size:14px;background:#fff
    }
    .f textarea{height:110px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .modal__foot{display:flex;justify-content:flex-end;gap:10px;padding:12px 14px;border-top:1px solid #eef1f4;background:linear-gradient(#fff,#fff)}
    .btn-secondary{background:#fff;border:1px solid #e6e6e6;color:#333;height:40px;padding:0 14px;border-radius:10px}
    .btn-accent{background:var(--brand);color:#fff;position:relative;height:40px;padding:0 16px;border-radius:10px;border:none;cursor:pointer}
    .btn-accent::before{content:"";position:absolute;inset:auto auto 8px 12px;width:6px;height:6px;border-radius:999px;background:var(--accent)}
    .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="index.html">Back to results</a>
    </div>

    <div id="loading" class="muted">Loading…</div>

    <div id="content" style="display:none">
      <h1 id="prop-title">Property</h1>
      <div class="muted" id="prop-sub"></div>
      <div class="chips" id="prop-chips"></div>

      <div class="layout">
        <!-- LEFT -->
        <div>
          <div class="hero-card">
            <div class="hero" id="hero"></div>
            <div class="gallery" id="thumbs"></div>
          </div>

          <!-- Facts -->
          <div class="section">
            <div class="card">
              <div class="card__title">Key details</div>
              <div class="card__body"><div class="facts" id="facts"></div></div>
            </div>
          </div>

          <!-- Overview -->
          <div class="section" id="overviewCard" style="display:none">
            <div class="card">
              <div class="card__title"><h2>Overview</h2></div>
              <div class="card__body" id="overview"></div>
            </div>
          </div>

          <!-- Features -->
          <div class="section" id="featuresCard" style="display:none">
            <div class="card">
              <div class="card__title"><h2>Key features</h2></div>
              <div class="card__body"><ul class="features" id="features"></ul></div>
            </div>
          </div>

          <!-- Description -->
          <div class="section" id="descCard" style="display:none">
            <div class="card">
              <div class="card__title"><h2>Description</h2></div>
              <div class="card__body" id="desc"></div>
            </div>
          </div>

          <!-- Location -->
          <div class="section" id="locCard" style="display:none">
            <div class="card">
              <div class="card__title"><h2>Location</h2></div>
              <div class="card__body" id="loc"></div>
            </div>
          </div>

          <!-- Transport (optional) -->
          <div class="section" id="transportCard" style="display:none">
            <div class="card">
              <div class="card__title"><h2>Transport</h2></div>
              <div class="card__body" id="transport"></div>
            </div>
          </div>
        </div>

        <!-- RIGHT (sticky) -->
        <aside class="sticky">
          <div class="card">
            <div class="card__title">Enquire about this property</div>
            <div class="card__body">
              <div class="actions">
                <button class="btn btn-primary" id="enquireBtn" type="button">Enquire now</button>
                <a class="btn btn-ghost" id="brochureBtn" target="_blank" rel="noopener">Download brochure</a>
              </div>
              <div id="map"></div>
            </div>
          </div>

          <div class="card" id="teamBox" style="display:none">
            <div class="card__title">Viewings & further information</div>
            <div id="agents"></div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Enquiry modal -->
  <div class="modal" id="enquiryModal" aria-hidden="true" role="dialog" aria-labelledby="enqTitle">
    <div class="modal__backdrop" data-close></div>
    <div class="modal__panel" role="document">
      <div class="modal__head">
        <div class="modal__title" id="enqTitle">Enquire now</div>
        <button class="modal__close" type="button" title="Close" data-close aria-label="Close">✕</button>
      </div>

      <div class="modal__body">
        <!-- agent pills -->
        <div class="pillbar" id="enqPills"></div>

        <!-- form -->
        <form id="enqForm" novalidate>
          <div class="grid2">
            <div class="f">
              <label for="titleSel">Title</label>
              <select id="titleSel" name="title">
                <option value="">—</option>
                <option>Mr</option><option>Mrs</option><option>Ms</option>
                <option>Miss</option><option>Dr</option>
              </select>
            </div>
            <span class="sr-only"></span>
          </div>

          <div class="grid2" style="margin-top:6px">
            <div class="f">
              <label for="firstName">First name*</label>
              <input id="firstName" name="firstName" required />
            </div>
            <div class="f">
              <label for="lastName">Last name*</label>
              <input id="lastName" name="lastName" required />
            </div>
          </div>

          <div class="grid2" style="margin-top:6px">
            <div class="f">
              <label for="email">Email*</label>
              <input id="email" name="email" type="email" required />
            </div>
            <div class="f">
              <label for="phone">Phone</label>
              <input id="phone" name="phone" />
            </div>
          </div>

          <div class="grid2" style="margin-top:6px">
            <div class="f">
              <label for="company">Company</label>
              <input id="company" name="company" />
            </div>
            <div class="f">
              <label for="jobTitle">Job title</label>
              <input id="jobTitle" name="jobTitle" />
            </div>
          </div>

          <div class="f" style="margin-top:6px">
            <label for="message">Message</label>
            <textarea id="message" name="message" placeholder="Tell us a bit about your requirement"></textarea>
          </div>

          <label style="display:flex;align-items:center;gap:10px;margin-top:8px;font-size:14px">
            <input type="checkbox" id="optIn" /> Add me to your mailing list
          </label>

          <div class="hint" id="propRefHint"></div>
          <div class="hint">Prefer email? Use the agent links above — they open your mail app.</div>
        </form>
      </div>

      <div class="modal__foot">
        <button class="btn btn-secondary" type="button" data-close>Cancel</button>
        <button class="btn btn-accent" type="button" id="sendEnquiryBtn">Send enquiry</button>
      </div>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */
const $  = (s, el=document) => el.querySelector(s);
const $$ = (s, el=document) => [...el.querySelectorAll(s)];
function getParam(name){ return new URLSearchParams(location.search).get(name); }
function pick(...vals){ return vals.find(v => v !== undefined && v !== null && v !== ''); }
function initials(name){ if(!name) return ""; return String(name).trim().split(/\s+/).slice(0,2).map(w=>w[0]?.toUpperCase()||"").join(""); }

function getImages(p){
  const arr=[];
  if (Array.isArray(p.images)) {
    for (const it of p.images) {
      if (typeof it === 'string') arr.push(it);
      else if (it?.url) arr.push(it.url);
      else if (it?._) arr.push(it._);
    }
  }
  if (!arr.length && Array.isArray(p.photos)) for (const ph of p.photos) if (ph?.url) arr.push(ph.url);
  const fallback = pick(p.image, p.image_url);
  if (fallback) arr.unshift(fallback);
  return [...new Set(arr)].filter(Boolean);
}
function toListItems(val){
  if (!val) return [];
  if (Array.isArray(val)) return val.map(String).filter(Boolean);
  return String(val).split(/\r?\n|•/g).map(s => s.trim()).filter(Boolean);
}
function formatSize(p){
  const a=p.size_from_sqft, b=p.size_to_sqft;
  if (a && b) return `${Number(a).toLocaleString()}–${Number(b).toLocaleString()} sq ft`;
  if (a) return `${Number(a).toLocaleString()} sq ft`;
  if (b) return `${Number(b).toLocaleString()} sq ft`;
  return '';
}
function buildSubject(p){
  return `Enquiry: ${p.address || 'Property'} (${p.id ?? ''})`;
}
function buildBody(p, form){
  const lines = [
    "Hi,",
    "",
    "I'd like more information about:",
    `${p.address || 'Property'}`,
    `${[p.town, p.postcode].filter(Boolean).join(' ')}`,
    `Ref: ${p.id ?? ''}`,
    "",
    `Name: ${[form.firstName, form.lastName].filter(Boolean).join(' ')}`,
    `Company: ${form.company || ''}`,
    `Job title: ${form.jobTitle || ''}`,
    `Email: ${form.email || ''}`,
    `Phone: ${form.phone || ''}`,
    "",
    (form.message || "Please reply to me via email/phone.")
  ];
  if ($('#optIn').checked) lines.push("", "✓ Please add me to your mailing list");
  return lines.join("\n");
}

/* ---------- page ---------- */
let map, marker, currentProperty=null;

// expose sendHeight early so we can call it after rendering
let _sendHeight = () => {};

async function main(){
  const id = getParam('id');
  const res = await fetch('./properties.json', { cache:'no-store' });
  const list = await res.json();
  const items = list.map((p,i)=>({ id: p.id ?? p.slug ?? p.uid ?? i, ...p }));
  const p = items.find(x => String(x.id) === String(id)) || items[0];
  currentProperty = p;

  if (!p){ $('#loading').textContent = 'Property not found.'; return; }

  document.title = p.address ? `${p.address} — Property` : 'Property';
  $('#loading').style.display = 'none';
  $('#content').style.display = '';

  /* header */
  $('#prop-title').textContent = p.address || 'Property';
  $('#prop-sub').textContent = [p.town, p.postcode].filter(Boolean).join(' ');
  const chips = $('#prop-chips');
  const tType  = pick(p.type, p.property_type, Array.isArray(p.types)&&p.types[0]);
  const tenure = pick(p.tenure, p.transaction_type, p.to_let ? 'To Let' : (p.for_sale ? 'For Sale' : ''));
  const epcObj = p.current_energy_ratings?.rating;
  const epc    = pick(p.epc_rating, p.epc, epcObj ? `${epcObj._ || epcObj} (${epcObj?.$?.value || ""})` : "");
  if (tenure) chips.innerHTML += `<span class="chip chip--accent">${tenure}</span>`;
  if (tType)  chips.innerHTML += `<span class="chip">${tType}</span>`;
  if (epc)    chips.innerHTML += `<span class="chip">EPC ${epc}</span>`;

  /* gallery */
  const imgs = getImages(p);
  const hero = $('#hero'); const thumbs = $('#thumbs');
  const setHero = (src) => { hero.innerHTML = src ? `<img src="${src}" alt="${p.address||'Property'}">` : ''; };
  setHero(imgs[0] || '');
  thumbs.innerHTML = imgs.slice(0,15).map(u => `<button class="thumb" type="button" data-src="${u}" aria-label="View photo"><img src="${u}" alt=""></button>`).join('');
  thumbs.addEventListener('click', e => {
    const t = e.target.closest('.thumb'); if (!t) return;
    setHero(t.dataset.src);
    thumbs.scrollTo({ left: t.offsetLeft - 12, behavior:'smooth' });
    _sendHeight();
  });

  /* facts */
  const facts = $('#facts');
  const fact = (label, value) => value ? `<div class="fact"><div class="label">${label}</div><div class="value">${value}</div></div>` : '';
  const ratesPay = p.business_rates?.rates_payable ? `${p.business_rates.rates_payable} per sq ft` : p.business_rates_psf || '';
  const rv = p.business_rates?.rateable_value ? `£${Number(p.business_rates.rateable_value).toLocaleString()}` : p.rateable_value || '';
  facts.innerHTML = [
    fact('Property type', tType),
    fact('Tenure', tenure),
    fact('Size', formatSize(p)),
    fact('Rent', pick(p.rent, p.rent_psf)),
    fact('Business rates', ratesPay),
    fact('Rateable value', rv),
    fact('EPC', epc),
    fact('Last updated', p.last_updated || '')
  ].join('');

  /* text blocks */
  const overview = pick(p.specification_summary?._, p.summary);
  if (overview){ $('#overview').innerHTML = overview; $('#overviewCard').style.display=''; }

  const feats = toListItems(p.key_selling_points?.key_selling_point || p.features || p.key_features);
  if (feats.length){ $('#features').innerHTML = feats.map(f=>`<li>${f}</li>`).join(''); $('#featuresCard').style.display=''; }

  const desc = pick(p.specification_description?._, p.description);
  if (desc){ $('#desc').innerHTML = desc; $('#descCard').style.display=''; }

  const loc = pick(p.location?._, p.location);
  if (loc){ $('#loc').innerHTML = loc; $('#locCard').style.display=''; }

  const transport = pick(p.marketing_text_transport?._, p.marketing_text_transport);
  if (transport){ $('#transport').innerHTML = transport; $('#transportCard').style.display=''; }

  /* actions (brochure) */
  const brochure = pick(p.brochure, p.brochure_url, p.files?.file?.url);
  if (brochure){ $('#brochureBtn').href = brochure; $('#brochureBtn').style.display='inline-flex'; }
  else { $('#brochureBtn').style.display='none'; }

  /* map */
  map = L.map('map', { zoomControl:true }).setView([52.5,-1.8], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  const lat = Number(p.lat), lon = Number(p.lon);
  if (isFinite(lat) && isFinite(lon)){
    marker = L.circleMarker([lat, lon], { radius:7, weight:2, color:'#111', fillColor:'#111', fillOpacity:.85 }).addTo(map);
    map.setView([lat, lon], 14);
  }

  /* agents (aside) */
  const contacts = Array.isArray(p.contacts?.contact) ? p.contacts.contact
                 : Array.isArray(p.contacts) ? p.contacts
                 : p.contacts ? [p.contacts] : [];
  if (contacts.length){
    const list = $('#agents');
    list.innerHTML = contacts.map(c => {
      const photo = c.photo || c.image || '';
      const init  = initials(c.name || '');
      const tel   = c.tel || c.phone || '';
      const mob   = c.mobile ? String(c.mobile) : '';
      return `
        <div class="agent">
          <div class="avatar">
            ${photo ? `<img src="${photo}" alt="${c.name||'Agent'}" onerror="this.closest('.avatar').textContent='${init}'">` : `${init}`}
          </div>
          <div>
            <div class="name">${c.name || ''}</div>
            <div class="meta">${[c.office, c.branch].filter(Boolean).join(' • ')}</div>
            <div class="meta">${[tel, mob].filter(Boolean).join(' • ')}</div>
            <div class="cta">
              ${c.email ? `<a href="mailto:${c.email}">Email</a>` : ''}
              ${tel ? `<a href="tel:${tel}">Call</a>` : ''}
              ${mob ? `<a href="tel:${mob}">Mobile</a>` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
    $('#teamBox').style.display = '';
  }

  /* ensure parent gets final height after all renderings */
  requestAnimationFrame(()=>{ _sendHeight(); });
  setTimeout(()=>{ _sendHeight(); }, 300);
  setTimeout(()=>{ _sendHeight(); }, 900);
}

/* ---------- enquiry modal logic ---------- */
function setupEnquiry(p){
  const modal = $('#enquiryModal');
  const pills = $('#enqPills');
  const propRef = `Enquiry about “${p.address || 'Property'}” ${[p.town,p.postcode].filter(Boolean).join(' ')}`;
  $('#propRefHint').textContent = propRef;

  const contacts = Array.isArray(p.contacts?.contact) ? p.contacts.contact
                 : Array.isArray(p.contacts) ? p.contacts
                 : p.contacts ? [p.contacts] : [];

  pills.innerHTML = contacts.slice(0,3).map(c=>{
    const init = initials(c.name||'');
    const photo = c.photo || c.image || '';
    const tel   = c.tel || c.phone || '';
    const mob   = c.mobile ? String(c.mobile) : '';
    const phones = [tel,mob].filter(Boolean).join(' · ');
    return `
      <div class="contact-pill">
        <div class="pill-avatar">
          ${photo ? `<img src="${photo}" alt="${c.name||'Agent'}" onerror="this.closest('.pill-avatar').textContent='${init}'">` : `${init}`}
        </div>
        <div>
          <div class="pill-name">${c.name||'Agent'}</div>
          <div class="pill-meta">${phones}</div>
          ${c.email ? `<div class="pill-meta"><a href="mailto:${c.email}">Email ${c.name?.split(' ')[0]||'agent'}</a></div>` : ``}
        </div>
      </div>
    `;
  }).join('') || `<div class="pill-meta">No named agents available.</div>`;

  const open = ()=>{ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); _sendHeight(); };
  const close = ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); _sendHeight(); };
  $('#enquireBtn').onclick = open;
  modal.addEventListener('click', e => { if (e.target.dataset.close !== undefined) close(); });
  $$('.modal__close', modal).forEach(b=>b.onclick=close);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

  $('#sendEnquiryBtn').onclick = () => {
    // simple validation
    const first = $('#firstName').value.trim();
    const last  = $('#lastName').value.trim();
    const email = $('#email').value.trim();
    if (!first || !last || !email) { alert('Please fill in first name, last name and email.'); return; }

    const formData = {
      title: $('#titleSel').value,
      firstName: first,
      lastName: last,
      email,
      phone: $('#phone').value.trim(),
      company: $('#company').value.trim(),
      jobTitle: $('#jobTitle').value.trim(),
      message: $('#message').value.trim()
    };

    // send via mailto to first available agent, else default AS parse inbox
    const toList = (Array.isArray(p.contacts) ? p.contacts : (p.contacts?.contact ? [p.contacts.contact] : []))
      .flat().map(c=>c?.email).filter(Boolean);
    const to = toList[0] || "gjs-dillon-limited-393@parse.agents-society.com";

    const subject = buildSubject(p);
    const body = buildBody(p, formData);
    const href = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = href;
    close();
  };
}

main();
</script>

<!-- ======= EMBED AUTO-RESIZE (stable; measures only .wrap) ======= -->
<script>
(function () {
  const MSG_TYPE = 'gjs-prop-height';
  const frameId = new URLSearchParams(location.search).get('frameId') || 'prop';
  const root = document.querySelector('.wrap') || document.body;

  function getContentHeight() {
    return Math.ceil((root?.offsetHeight || document.body.offsetHeight) + 24);
  }

  let last = 0;
  function send() {
    const h = getContentHeight();
    if (h !== last) {
      last = h;
      window.parent?.postMessage({ type: MSG_TYPE, id: frameId, height: h }, '*');
    }
  }

  // Expose to the page code above
  window._gjsSendHeight = send;
  _sendHeight = send;

  // Observe only the content wrapper to avoid feedback loops
  const ro = new ResizeObserver(send);
  ro.observe(root);

  const mo = new MutationObserver(send);
  mo.observe(root, { childList: true, subtree: true, attributes: true });

  window.addEventListener('load', send);
  setTimeout(send, 300);
  setTimeout(send, 1000);

  // Keep inner doc from scrolling / forcing viewport height
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
  document.documentElement.style.height = 'auto';
  document.body.style.height = 'auto';
})();
</script>
</body>
</html>
