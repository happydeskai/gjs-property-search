<!-- ✅ UPDATED property.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* same CSS as before — unchanged */
  </style>
</head>
<body>
  <!-- same HTML layout as before — unchanged -->

<script>
/* ---------- helpers ---------- */
const $  = (s, el=document) => el.querySelector(s);
const $$ = (s, el=document) => [...el.querySelectorAll(s)];
function getParam(name){ return new URLSearchParams(location.search).get(name); }
function pick(...vals){ return vals.find(v => v !== undefined && v !== null && v !== ''); }
function initials(name){ if(!name) return ""; return String(name).trim().split(/\s+/).slice(0,2).map(w=>w[0]?.toUpperCase()||"").join(""); }

function getImages(p){
  const arr=[];
  if (Array.isArray(p.images)) {
    for (const it of p.images) {
      if (typeof it === 'string') arr.push(it);
      else if (it?.url) arr.push(it.url);
      else if (it?._) arr.push(it._);
    }
  }
  if (!arr.length && Array.isArray(p.photos)) for (const ph of p.photos) if (ph?.url) arr.push(ph.url);
  const fallback = pick(p.image, p.image_url);
  if (fallback) arr.unshift(fallback);
  return [...new Set(arr)].filter(Boolean);
}
function toListItems(val){
  if (!val) return [];
  if (Array.isArray(val)) return val.map(String).filter(Boolean);
  return String(val).split(/\r?\n|•/g).map(s => s.trim()).filter(Boolean);
}
function formatSize(p){
  const a=p.size_from_sqft, b=p.size_to_sqft;
  if (a && b) return `${Number(a).toLocaleString()}–${Number(b).toLocaleString()} sq ft`;
  if (a) return `${Number(a).toLocaleString()} sq ft`;
  if (b) return `${Number(b).toLocaleString()} sq ft`;
  return '';
}
function buildSubject(p){
  return `Enquiry: ${p.address || 'Property'} (${p.id ?? ''})`;
}
function buildBody(p, form){
  const lines = [
    "Hi,",
    "",
    "I'd like more information about:",
    `${p.address || 'Property'}`,
    `${[p.town, p.postcode].filter(Boolean).join(' ')}`,
    `Ref: ${p.id ?? ''}`,
    "",
    `Name: ${[form.firstName, form.lastName].filter(Boolean).join(' ')}`,
    `Company: ${form.company || ''}`,
    `Job title: ${form.jobTitle || ''}`,
    `Email: ${form.email || ''}`,
    `Phone: ${form.phone || ''}`,
    "",
    (form.message || "Please reply to me via email/phone.")
  ];
  if ($('#optIn').checked) lines.push("", "✓ Please add me to your mailing list");
  return lines.join("\n");
}

/* ---------- page ---------- */
let map, marker, currentProperty=null;
let _sendHeight = () => {};

async function main(){
  try {
    const id = getParam('id');
    const res = await fetch('./properties.json', { cache:'no-store' });
    if (!res.ok) throw new Error(`properties.json HTTP ${res.status}`);
    const list = await res.json();
    const items = list.map((p,i)=>({ id: p.id ?? p.slug ?? p.uid ?? i, ...p }));
    const p = items.find(x => String(x.id) === String(id)) || items[0];
    currentProperty = p;

    if (!p){ $('#loading').textContent = 'Property not found.'; return; }

    document.title = p.address ? `${p.address} — Property` : 'Property';
    $('#loading').style.display = 'none';
    $('#content').style.display = '';

    /* header */
    $('#prop-title').textContent = p.address || 'Property';
    $('#prop-sub').textContent = [p.town, p.postcode].filter(Boolean).join(' ');

    const chips = $('#prop-chips');
    const tType  = pick(p.type, p.property_type, Array.isArray(p.types)&&p.types[0]);
    const tenure = pick(p.tenure, p.transaction_type, p.to_let ? 'To Let' : (p.for_sale ? 'For Sale' : ''));
    const epcObj = p.current_energy_ratings?.rating;
    const epc    = pick(p.epc_rating, p.epc, epcObj ? `${epcObj._ || epcObj} (${epcObj?.$?.value || ""})` : "");
    if (tenure) chips.innerHTML += `<span class="chip chip--accent">${tenure}</span>`;
    if (tType)  chips.innerHTML += `<span class="chip">${tType}</span>`;
    if (epc)    chips.innerHTML += `<span class="chip">EPC ${epc}</span>`;

    /* gallery */
    const imgs = getImages(p);
    const hero = $('#hero'); const thumbs = $('#thumbs');
    const setHero = (src) => { hero.innerHTML = src ? `<img src="${src}" alt="${p.address||'Property'}">` : ''; };
    setHero(imgs[0] || '');
    thumbs.innerHTML = imgs.slice(0,15).map(u => `<button class="thumb" type="button" data-src="${u}" aria-label="View photo"><img src="${u}" alt=""></button>`).join('');
    thumbs.addEventListener('click', e => {
      const t = e.target.closest('.thumb'); if (!t) return;
      setHero(t.dataset.src);
      thumbs.scrollTo({ left: t.offsetLeft - 12, behavior:'smooth' });
      _sendHeight();
    });

    /* facts */
    const facts = $('#facts');
    const fact = (label, value) => value ? `<div class="fact"><div class="label">${label}</div><div class="value">${value}</div></div>` : '';
    const ratesPay = p.business_rates?.rates_payable ? `${p.business_rates.rates_payable} per sq ft` : p.business_rates_psf || '';
    const rv = p.business_rates?.rateable_value ? `£${Number(p.business_rates.rateable_value).toLocaleString()}` : p.rateable_value || '';
    facts.innerHTML = [
      fact('Property type', tType),
      fact('Tenure', tenure),
      fact('Size', formatSize(p)),
      fact('Rent', pick(p.rent, p.rent_psf)),
      fact('Business rates', ratesPay),
      fact('Rateable value', rv),
      fact('EPC', epc),
      fact('Last updated', p.last_updated || '')
    ].join('');

    /* text blocks */
    const overview = pick(p.specification_summary?._, p.summary);
    if (overview){ $('#overview').innerHTML = overview; $('#overviewCard').style.display=''; }

    const feats = toListItems(p.key_selling_points?.key_selling_point || p.features || p.key_features);
    if (feats.length){ $('#features').innerHTML = feats.map(f=>`<li>${f}</li>`).join(''); $('#featuresCard').style.display=''; }

    /* ✅ smart handling for Description + Location */
    const rawDesc = pick(p.specification_description?._, p.description) || '';
    const rawLoc  = pick(p.location?._, p.location) || '';

    let descText = rawDesc;
    let locText = rawLoc;

    // If no location field but description contains "Location", split it
    if (!rawLoc && /Location\s/i.test(rawDesc)) {
      const parts = rawDesc.split(/Location\s/i);
      descText = parts[0].trim();
      locText = 'Location ' + (parts[1]?.trim() || '');
    }

    if (descText) { $('#desc').innerHTML = descText; $('#descCard').style.display=''; }
    if (locText)  { $('#loc').innerHTML = locText; $('#locCard').style.display=''; }

    const transport = pick(p.marketing_text_transport?._, p.marketing_text_transport);
    if (transport){ $('#transport').innerHTML = transport; $('#transportCard').style.display=''; }

    /* actions (brochure) */
    const brochure = pick(p.brochure, p.brochure_url, p.files?.file?.url);
    if (brochure){ $('#brochureBtn').href = brochure; $('#brochureBtn').style.display='inline-flex'; }
    else { $('#brochureBtn').style.display='none'; }

    /* map */
    map = L.map('map', { zoomControl:true }).setView([52.5,-1.8], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const lat = Number(p.lat), lon = Number(p.lon);
    if (isFinite(lat) && isFinite(lon)){
      marker = L.circleMarker([lat, lon], { radius:7, weight:2, color:'#111', fillColor:'#111', fillOpacity:.85 }).addTo(map);
      map.setView([lat, lon], 14);
    }

    /* agents (aside) — unchanged */
    const contacts = Array.isArray(p.contacts?.contact) ? p.contacts.contact
                 : Array.isArray(p.contacts) ? p.contacts
                 : p.contacts ? [p.contacts] : [];
    if (contacts.length){
      const list = $('#agents');
      list.innerHTML = contacts.map(c => {
        const photo = c.photo || c.image || '';
        const init  = initials(c.name || '');
        const tel   = c.tel || c.phone || '';
        const mob   = c.mobile ? String(c.mobile) : '';
        return `
          <div class="agent">
            <div class="avatar">
              ${photo ? `<img src="${photo}" alt="${c.name||'Agent'}" onerror="this.closest('.avatar').textContent='${init}'">` : `${init}`}
            </div>
            <div>
              <div class="name">${c.name || ''}</div>
              <div class="meta">${[c.office, c.branch].filter(Boolean).join(' • ')}</div>
              <div class="meta">${[tel, mob].filter(Boolean).join(' • ')}</div>
              <div class="cta">
                ${c.email ? `<a href="mailto:${c.email}">Email</a>` : ''}
                ${tel ? `<a href="tel:${tel}">Call</a>` : ''}
                ${mob ? `<a href="tel:${mob}">Mobile</a>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
      $('#teamBox').style.display = '';
    }

    setupEnquiry(p);

    requestAnimationFrame(()=>{ _sendHeight(); });
    setTimeout(()=>{ _sendHeight(); }, 300);
    setTimeout(()=>{ _sendHeight(); }, 900);

  } catch (err) {
    console.error(err);
    const msg = (err && err.message) ? err.message : String(err);
    $('#loading').textContent = `Sorry — failed to load property data (${msg}).`;
  }
}

/* ---------- enquiry modal logic ---------- */
/* (same as before) */

main();
</script>

<!-- ======= EMBED AUTO-RESIZE (unchanged) ======= -->
</body>
</html>
