<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ----- base ----- */
    *,*::before,*::after{box-sizing:border-box}
    :root{
      --radius:12px; --gap:18px;
      --border:1px solid #e8e8e8;
      --text:#111; --muted:#666; --bg:#fff;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --chip:#f6f6f6;
    }
    html,body{margin:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;color:var(--text);background:#fff}
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:28px 18px 72px}
    .topbar{margin-bottom:14px}
    .back{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:#111}
    h1{margin:6px 0 6px;font-size:28px;line-height:1.2}
    .muted{color:var(--muted);font-size:14px}

    /* ----- layout ----- */
    .layout{display:grid;grid-template-columns:1.6fr .9fr;gap:24px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}

    /* ----- media / gallery ----- */
    .media{background:#eee;border-radius:12px;overflow:hidden}
    .hero{position:relative;aspect-ratio:16/9}
    .hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .thumbs{display:flex;gap:10px;padding:10px 2px 2px;overflow:auto}
    .thumb{flex:0 0 140px;aspect-ratio:16/10;border-radius:10px;overflow:hidden;border:1px solid #eee;cursor:pointer;opacity:.9;transition:opacity .15s}
    .thumb:hover{opacity:1}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}

    /* ----- cards/boxes ----- */
    .box{border:var(--border);border-radius:12px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .box.pad{padding:14px}
    .box h3{margin:0 0 10px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.02em}

    /* enquire panel + map */
    .actions{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
    .btn{height:44px;padding:0 16px;border-radius:10px;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-weight:600;text-decoration:none}
    .btn-primary{background:#111;color:#fff}
    .btn-ghost{background:#fff;border:1px solid #ddd}
    #map{height:280px;border-radius:12px;overflow:hidden}

    /* spec table */
    .spec{margin-top:var(--gap)}
    .row{display:grid;grid-template-columns:200px 1fr;gap:10px;padding:14px 16px;border-top:var(--border)}
    .row:first-child{border-top:none}
    .label{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.02em}

    /* sections */
    .section{margin-top:22px}
    .section h2{font-size:18px;margin:0 0 8px}
    .features{margin:0;padding-left:18px}
    .features li{margin:6px 0}

    /* contacts */
    .agentlist{display:grid;gap:12px}
    .agent{display:grid;grid-template-columns:56px 1fr;gap:12px;align-items:center;padding:10px 0;border-top:var(--border)}
    .agent:first-child{border-top:none}
    .avatar{width:56px;height:56px;border-radius:50%;overflow:hidden;background:#eee;display:grid;place-items:center;font-weight:700;color:#333}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .agent .name{font-weight:600}
    .agent .meta{font-size:13px;color:var(--muted)}
    .agent .cta{margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
    .agent .cta a{font-size:13px;text-decoration:underline}
    .chip{display:inline-block;background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px}
    .inline-links a{color:#111;text-decoration:underline}

    /* small helpers */
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="index.html">← Back to results</a>
    </div>

    <div id="loading" class="muted">Loading…</div>
    <div id="content" class="hide">
      <div class="layout">
        <!-- LEFT -->
        <div>
          <div id="heading"></div>

          <div class="media box">
            <div class="hero" id="hero"></div>
            <div class="thumbs" id="thumbs"></div>
          </div>

          <div class="box spec" id="spec"></div>

          <div class="section" id="overviewBlock" class="hide">
            <h2>Overview</h2>
            <div id="overview" class="muted"></div>
          </div>

          <div class="section" id="featuresBlock" class="hide">
            <h2>Key features</h2>
            <ul class="features" id="features"></ul>
          </div>

          <div class="section" id="descBlock" class="hide">
            <h2>Description</h2>
            <div id="desc" class="muted"></div>
          </div>

          <div class="section" id="locBlock" class="hide">
            <h2>Location</h2>
            <div id="loc" class="muted"></div>
          </div>

          <div class="section inline-links" id="linksBlock" class="hide"></div>
        </div>

        <!-- RIGHT -->
        <div>
          <div class="box pad">
            <h3>Enquire about this property</h3>
            <div class="actions">
              <a class="btn btn-primary" id="enquireBtn" target="_blank" rel="noopener">Enquire now</a>
              <a class="btn btn-ghost" id="brochureBtn" target="_blank" rel="noopener">Download brochure</a>
            </div>
            <div id="map"></div>
          </div>

          <div class="box pad section" id="teamBox" class="hide">
            <h3>Viewings & further information</h3>
            <div class="agentlist" id="agents"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- utils ---------- */
const $ = (s, el=document) => el.querySelector(s);
const on = (el, evt, fn) => el.addEventListener(evt, fn);
const getParam = (k) => new URLSearchParams(location.search).get(k);
const pick = (...a) => a.find(v => v !== undefined && v !== null && v !== '');
const toParagraphs = (txt) =>
  String(txt).split(/\n{2,}|\r\r/).map(s=>s.trim()).filter(Boolean).map(s=>`<p>${s}</p>`).join("");

/* make inline SVG initials avatar so we don’t depend on 3rd parties */
function makeInitialsAvatar(name = "Agent"){
  const [a="",b=""] = name.trim().split(/\s+/);
  const inits = (a[0]||"A") + (b[0]||"");
  const svg = encodeURIComponent(
`<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'>
  <rect width='100%' height='100%' fill='#e9ecef'/>
  <text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle'
    font-family='system-ui, -apple-system, Segoe UI, Roboto, Arial' font-size='44' fill='#343a40' font-weight='700'>${inits}</text>
</svg>`);
  return `data:image/svg+xml;charset=utf-8,${svg}`;
}

/* images can be array of strings or {url|_} */
function getImages(p){
  const list = [];
  if (Array.isArray(p.images)) {
    for (const it of p.images) {
      if (typeof it === 'string') list.push(it);
      else if (it?.url) list.push(it.url);
      else if (it?._) list.push(it._);
    }
  }
  if (!list.length && Array.isArray(p.photos)) {
    for (const ph of p.photos){ if (ph?.url) list.push(ph.url); }
  }
  const fallback = pick(p.image, p.image_url);
  if (fallback) list.unshift(fallback);
  return [...new Set(list)].filter(Boolean);
}

function fmtMoney(n){ const x=Number(n); return Number.isFinite(x)?`£${x.toFixed(2)}`:''; }
function fmtRV(n){ const x=Number(n); return Number.isFinite(x)?`£${x.toLocaleString()}`:''; }

function row(label, value){
  if (!value) return '';
  return `<div class="row"><div class="label">${label}</div><div>${value}</div></div>`;
}

function niceSize(p){
  const a=p.size_from_sqft, b=p.size_to_sqft;
  if (a && b) return `${a}–${b} sq ft`;
  if (a) return `${a} sq ft`;
  if (b) return `${b} sq ft`;
  return '';
}

function buildEnquiryUrl(p){
  const to = "gjs-dillon-limited-393@parse.agents-society.com";
  const subject = `Enquiry: ${p.address || 'Property'} (${p.id ?? ''})`;
  const lines = [
    "Hi,",
    "",
    "I'd like more information about:",
    `${p.address || 'Property'}`,
    `${[p.town, p.postcode].filter(Boolean).join(' ')}`,
    `Ref: ${p.id ?? ''}`,
    ""
  ];
  return `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(lines.join("\n"))}`;
}

/* ---------- main ---------- */
let map, marker;

async function main(){
  const id = getParam('id');
  const res = await fetch('./properties.json', { cache:'no-store' });
  const list = await res.json();
  const withIds = list.map((p,i)=>({ id: p.id ?? p.slug ?? p.uid ?? i, ...p }));
  const p = withIds.find(x => String(x.id) === String(id)) || withIds[0];
  if (!p){ $('#loading').textContent = 'Property not found.'; return; }

  document.title = p.address ? `${p.address} — Property` : 'Property';
  $('#loading').classList.add('hide');
  $('#content').classList.remove('hide');

  // heading
  $('#heading').innerHTML = `
    <h1>${p.address || 'Property'}</h1>
    <div class="muted">${[p.town, p.postcode].filter(Boolean).join(' ')}</div>
  `;

  /* gallery */
  const imgs = getImages(p);
  const hero = $('#hero'), thumbs = $('#thumbs');
  const setHero = (src) => { hero.innerHTML = src ? `<img src="${src}" alt="${p.address||'Property'}">` : ''; };
  setHero(imgs[0] || '');
  thumbs.innerHTML = imgs.slice(0,12).map(u => `
    <button class="thumb" type="button" data-src="${u}" aria-label="View photo">
      <img src="${u}" alt="">
    </button>`).join('');
  on(thumbs,'click',e=>{
    const t=e.target.closest('.thumb'); if(!t) return; setHero(t.dataset.src);
  });

  /* spec */
  const type = pick(p.type, p.property_type, Array.isArray(p.types)&&p.types[0]);
  const tenure = pick(p.tenure, p.transaction_type, p.to_let ? 'To Let' : (p.for_sale ? 'For Sale' : ''));
  const size = niceSize(p);
  const rent = pick(p.rent, p.rent_psf && `${fmtMoney(p.rent_psf)} per sq ft`);
  const rates = p.business_rates_psf && `${fmtMoney(p.business_rates_psf)} per sq ft`;
  const rv = p.rateable_value && fmtRV(p.rateable_value);
  const sc = p.service_charge;
  const ec = p.estate_charge;
  const epc = pick(p.epc_rating, p.epc);
  const updated = p.last_updated;

  $('#spec').innerHTML = [
    row('Property type', type),
    row('Tenure', tenure),
    row('Size', size),
    row('Rent', rent),
    row('Business rates', rates),
    row('Rateable value', rv),
    row('Service charge', sc),
    row('Estate charge', ec),
    row('Energy performance rating', epc),
    row('Last updated', updated),
  ].join('');

  /* sections */
  const overview = pick(p.specification_summary, p.summary);
  if (overview){ $('#overview').innerHTML = toParagraphs(overview); $('#overviewBlock').classList.remove('hide'); }

  const feats = Array.isArray(p.features) ? p.features : [];
  if (feats.length){
    $('#features').innerHTML = feats.map(f=>`<li>${f}</li>`).join('');
    $('#featuresBlock').classList.remove('hide');
  }

  const desc = pick(p.specification_description, p.description);
  if (desc){ $('#desc').innerHTML = toParagraphs(desc); $('#descBlock').classList.remove('hide'); }

  const locText = pick(p.location);
  if (locText){ $('#loc').innerHTML = toParagraphs(locText); $('#locBlock').classList.remove('hide'); }

  /* actions */
  const brochure = pick(p.brochure, p.brochure_url);
  const enquireUrl = buildEnquiryUrl(p);
  $('#enquireBtn').href = enquireUrl;
  if (brochure){ $('#brochureBtn').href = brochure; $('#brochureBtn').style.display='inline-flex'; }
  else { $('#brochureBtn').style.display='none'; }

  /* map */
  map = L.map('map', { zoomControl:true }).setView([52.5,-1.8], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  const lat = Number(p.lat), lon = Number(p.lon);
  if (isFinite(lat) && isFinite(lon)){
    marker = L.circleMarker([lat, lon], { radius:7, weight:2, color:'#111', fillColor:'#111', fillOpacity:.85 }).addTo(map);
    map.setView([lat, lon], 14);
  }

  /* contacts */
  const contacts = Array.isArray(p.contacts) ? p.contacts : [];
  if (contacts.length){
    const agents = $('#agents');
    agents.innerHTML = contacts.map(a=>{
      const nm = a.name || '';
      const avatar = a.photo || makeInitialsAvatar(nm);
      const lines = [
        [a.company, a.title].filter(Boolean).join(' • '),
        [a.phone, a.mobile].filter(Boolean).join(' • ')
      ].filter(Boolean).map(s=>`<div class="meta">${s}</div>`).join('');
      const mail = a.email ? `<a href="mailto:${a.email}">Email</a>` : '';
      const tel = a.phone ? `<a href="tel:${a.phone.replace(/\s+/g,'')}">Call</a>` : '';
      return `
        <div class="agent">
          <span class="avatar">${avatar.startsWith('http') ? `<img src="${avatar}" alt="${nm}">` : `<img src="${avatar}" alt="${nm}">`}</span>
          <div>
            <div class="name">${nm}</div>
            ${lines}
            <div class="cta">${mail}${mail&&tel?' · ':''}${tel}</div>
          </div>
        </div>`;
    }).join('');
    $('#teamBox').classList.remove('hide');
  }

  /* related link (source URL) */
  if (p.url){
    $('#linksBlock').innerHTML = `<a href="${p.url}" target="_blank" rel="noopener">View on agency site</a>`;
    $('#linksBlock').classList.remove('hide');
  }
}

main();
</script>
</body>
</html>
