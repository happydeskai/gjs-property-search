<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet (free map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --text:#111;
      --muted:#666;
      --border:#eaeaea;
      --bg:#fff;
      --chip:#f6f6f6;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);
    }

    * { box-sizing: border-box; }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    h1{
      margin: 0 0 16px 0;
      font-size: 34px;
      letter-spacing:-0.02em;
    }

    /* Top search bar */
    .searchBar{
      display: grid;
      grid-template-columns: 0.9fr 0.9fr 1.4fr 0.9fr 0.9fr auto;
      gap: 12px;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      box-shadow: var(--shadow);
      align-items: end;
    }

    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px 2px;
    }

    .field input, .field select{
      width: 100%;
      padding: 12px 12px;
      border: 1px solid #dcdcdc;
      border-radius: 10px;
      font-size: 14px;
      background: #fff;
      outline: none;
    }
    .field input:focus, .field select:focus{
      border-color:#bdbdbd;
    }

    .btn{
      padding: 12px 16px;
      border: 1px solid #1e1e1e;
      border-radius: 10px;
      background: #1e1e1e;
      color:#fff;
      font-size: 14px;
      cursor:pointer;
      height: 44px;
      align-self: end;
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }

    .secondaryRow{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-top: 14px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .metaLeft{
      display:flex;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size: 14px;
    }

    .sortWrap{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .sortWrap label{
      font-size: 14px;
      color: var(--muted);
    }
    .sortWrap select{
      padding: 10px 12px;
      border: 1px solid #dcdcdc;
      border-radius: 10px;
      font-size: 14px;
      background:#fff;
    }

    /* Map */
    #map{
      width: 100%;
      height: 340px;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin: 12px 0 22px;
    }

    /* Results */
    .resultsHeader{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin: 10px 0 14px;
      flex-wrap: wrap;
    }

    .count{
      font-size: 28px;
      letter-spacing:-0.02em;
      margin: 0;
    }
    .count span{
      color: var(--muted);
      font-weight: 500;
      font-size: 16px;
      margin-left: 8px;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 22px;
      padding-top: 18px;
      border-top: 1px solid var(--border);
    }

    .card{
      display:flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 10px;
    }

    .thumb{
      width: 100%;
      height: 180px;
      border-radius: 14px;
      overflow:hidden;
      background: #f3f3f3;
      border: 1px solid #efefef;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }

    .card h3{
      margin:0 0 6px 0;
      font-size: 18px;
      letter-spacing:-0.01em;
    }
    .sub{
      margin:0 0 10px 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }

    .chips{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0 10px;
    }
    .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid #ededed;
      color: #333;
    }

    .links{
      display:flex;
      gap: 14px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .links a{
      font-size: 14px;
      color: #111;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .empty{
      padding: 26px 6px;
      color: var(--muted);
      font-size: 14px;
    }

    @media (max-width: 980px){
      .searchBar{
        grid-template-columns: 1fr 1fr;
      }
      #map{ height: 300px; }
    }

    @media (max-width: 560px){
      .thumb{
        width: 100%;
        height: 180px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Property Search</h1>

    <!-- MAP (static first — pins only, no radius search yet) -->
    <div id="map"></div>

    <!-- TOP SEARCH BAR (Victor-style) -->
    <div class="searchBar">

      <div class="field">
        <label for="tenure">Tenure</label>
        <select id="tenure">
          <option value="any">Any</option>
          <option value="to_let">To Let</option>
          <option value="for_sale">For Sale</option>
        </select>
      </div>

      <div class="field">
        <label for="type">Type</label>
        <select id="type">
          <option value="any">Any</option>
        </select>
      </div>

      <div class="field">
        <label for="q">Location, postcode</label>
        <input id="q" type="text" placeholder="e.g. London, WR11 1JH" />
      </div>

      <div class="field">
        <label for="minSize">Min size (sq ft)</label>
        <input id="minSize" type="number" min="0" placeholder="Min size" />
      </div>

      <div class="field">
        <label for="maxSize">Max size (sq ft)</label>
        <input id="maxSize" type="number" min="0" placeholder="Max size" />
      </div>

      <button class="btn" id="searchBtn" type="button">Search</button>
    </div>

    <div class="secondaryRow">
      <div class="metaLeft" id="statusText">Loading properties…</div>

      <div class="sortWrap">
        <label for="sort">Sort by</label>
        <select id="sort">
          <option value="updated_desc">Updated (most recent first)</option>
          <option value="size_desc">Size (largest first)</option>
          <option value="size_asc">Size (smallest first)</option>
        </select>
      </div>
    </div>

    <div class="resultsHeader">
      <p class="count" id="resultsCount">0 <span>Properties Found</span></p>
    </div>

    <div class="cards" id="results"></div>
  </div>

  <script>
    // ---------- Helpers ----------
    function formatNumber(n){
      const num = Number(n);
      if (!Number.isFinite(num)) return '';
      return num.toLocaleString('en-GB');
    }

    function getPrimaryImage(p){
      if (!p) return '';
      if (p.image) return p.image;
      if (p.image_url) return p.image_url;
      if (p.main_image) return p.main_image;
      if (Array.isArray(p.photos) && p.photos.length){
        const first = p.photos[0];
        if (first && typeof first === 'object' && first.url) return first.url;
        if (typeof first === 'string') return first;
      }
      if (Array.isArray(p.images) && p.images.length){
        const first = p.images[0];
        if (first && typeof first === 'object'){
          if (first.url) return first.url;
          if (first._) return first._;
        }
      }
      return '';
    }

    function getTitle(p){
      const address = p.address || p.address1 || p.name || '';
      const town = p.town || '';
      return [address, town].filter(Boolean).join(', ') || 'Untitled property';
    }

    function getTypeLabel(p){
      if (Array.isArray(p.types) && p.types.length) return p.types.join(', ');
      // XML-style could be different — keep fallback
      if (Array.isArray(p.type) && p.type.length) return p.type.join(', ');
      return '—';
    }

    function getSizeLabel(p){
      const from = p.size_from_sqft ?? p.size_from ?? null;
      const to   = p.size_to_sqft ?? p.size_to ?? null;

      if (Number.isFinite(Number(from)) && Number.isFinite(Number(to))){
        if (Number(from) === Number(to)) return `${formatNumber(from)} sq ft`;
        return `${formatNumber(from)}–${formatNumber(to)} sq ft`;
      }
      if (Number.isFinite(Number(from))) return `${formatNumber(from)} sq ft`;
      if (Number.isFinite(Number(to))) return `${formatNumber(to)} sq ft`;
      return '—';
    }

    function getPostcodeLabel(p){
      return (p.postcode || '').trim();
    }

    function getTenureChips(p){
      const chips = [];
      if (p?.to_let) chips.push('To Let');
      if (p?.for_sale) chips.push('For Sale');
      return chips;
    }
    function parseUpdated(p){
      // "2025-12-15 16:06:35"
      const s = p.last_updated || p.updated_at || p.created_at || '';
      const d = new Date(s.replace(' ', 'T') + 'Z');
      return isNaN(d.getTime()) ? 0 : d.getTime();
    }

    // ---------- State ----------
    let allProperties = [];
    let map, markersLayer;

    // ---------- Map ----------
    function initMap(){
      map = L.map('map', {
        zoomControl: true,
        scrollWheelZoom: false
      });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);

      // default view (UK-ish) until we fit markers
      map.setView([52.5, -1.8], 6);
    }

    function setMapMarkers(properties){
      if (!map || !markersLayer) return;

      markersLayer.clearLayers();

      const pts = [];
      properties.forEach(p => {
        const lat = Number(p.lat);
        const lon = Number(p.lon);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;

        const title = getTitle(p);
        const type = getTypeLabel(p);
        const size = getSizeLabel(p);

        const marker = L.circleMarker([lat, lon], {
          radius: 6,
          weight: 1
        });

        marker.bindPopup(
          `<strong>${escapeHtml(title)}</strong><br/>${escapeHtml(type)} · ${escapeHtml(size)}`
        );

        marker.addTo(markersLayer);
        pts.push([lat, lon]);
      });

      if (pts.length){
        const bounds = L.latLngBounds(pts);
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    function escapeHtml(str){
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ---------- UI Options ----------
    function populateTypeOptions(properties){
      const typeSelect = document.getElementById('type');
      const set = new Set();

      properties.forEach(p => {
        if (Array.isArray(p.types)) p.types.forEach(t => set.add(String(t)));
      });

      const types = Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b));

      // keep "Any" then add
      typeSelect.innerHTML = `<option value="any">Any</option>` + types.map(t =>
        `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`
      ).join('');
    }

    // ---------- Filtering + Sorting ----------
    function applyFilters(){
      const q = (document.getElementById('q').value || '').trim().toLowerCase();
      const minSize = Number(document.getElementById('minSize').value || '');
      const maxSize = Number(document.getElementById('maxSize').value || '');
      const sort = document.getElementById('sort').value;
      const type = document.getElementById('type').value;
      const tenure = document.getElementById('tenure').value;

      let filtered = allProperties.slice();

      if (tenure !== 'any'){
        filtered = filtered.filter(p => tenure === 'to_let' ? p.to_let : p.for_sale);
      }

      if (type !== 'any'){
        filtered = filtered.filter(p => Array.isArray(p.types) && p.types.includes(type));
      }

      // text search only (safe)
      if (q){
        filtered = filtered.filter(p => {
          const hay = [
            p.address, p.address1, p.town, p.county, p.postcode
          ].filter(Boolean).join(' ').toLowerCase();
          return hay.includes(q);
        });
      }

      // size filter (safe)
      const hasMin = Number.isFinite(minSize);
      const hasMax = Number.isFinite(maxSize);

      if (hasMin || hasMax){
        filtered = filtered.filter(p => {
          const from = Number(p.size_from_sqft ?? p.size_from ?? NaN);
          const to = Number(p.size_to_sqft ?? p.size_to ?? NaN);

          if (!Number.isFinite(from) && !Number.isFinite(to)) return false;

          const low = Number.isFinite(from) ? from : to;
          const high = Number.isFinite(to) ? to : from;

          if (hasMin && high < minSize) return false;
          if (hasMax && low > maxSize) return false;
          return true;
        });
      }

      // sort
      if (sort === 'updated_desc'){
        filtered.sort((a,b)=>parseUpdated(b)-parseUpdated(a));
      }

      renderResults(filtered);
      setMapMarkers(filtered);
    }

    // ---------- Rendering ----------
    function renderResults(properties){
      const results = document.getElementById('results');
      const count = document.getElementById('resultsCount');
      const statusText = document.getElementById('statusText');

      count.innerHTML = `${properties.length} <span>Properties Found</span>`;
      statusText.textContent = `Showing ${properties.length} of ${allProperties.length}`;

      if (!properties.length){
        results.innerHTML = `<div class="empty">No properties match your filters.</div>`;
        return;
      }

      results.innerHTML = properties.map(p => {
        const title = getTitle(p);
        const typeLabel = getTypeLabel(p);
        const sizeLabel = getSizeLabel(p);
        const postcode = getPostcodeLabel(p);
        const img = getPrimaryImage(p);
        const brochure = p.brochure_url || '';
        const detailsUrl = p.url || '';
        const tenureChips = getTenureChips(p);
        const metaParts = [
          typeLabel && typeLabel !== '—' ? typeLabel : '',
          sizeLabel && sizeLabel !== '—' ? sizeLabel : '',
          postcode
        ].filter(Boolean);

        return `
          <div class="card">
            <div class="thumb">
              ${img ? `<img src="${escapeHtml(img)}" alt="${escapeHtml(title)}">` : ``}
            </div>

            <div>
              <h3>${escapeHtml(title)}</h3>
              ${metaParts.length ? `<p class="sub">${metaParts.map(item => escapeHtml(item)).join(' · ')}</p>` : ``}

              ${tenureChips.length ? `
                <div class="chips">
                  ${tenureChips.map(c => `<span class="chip">${escapeHtml(c)}</span>`).join('')}
                </div>
              ` : ``}

              ${(brochure || detailsUrl) ? `
                <div class="links">
                  ${brochure ? `<a href="${escapeHtml(brochure)}" target="_blank" rel="noopener">View brochure</a>` : ``}
                  ${detailsUrl ? `<a href="${escapeHtml(detailsUrl)}" target="_blank" rel="noopener">View details</a>` : ``}
                </div>
              ` : ``}
            </div>
          </div>
        `;
      }).join('');
    }

    // ---------- Load ----------
    async function loadProperties(){
      const statusText = document.getElementById('statusText');
      statusText.textContent = 'Loading properties…';

      let url = '';
      try{
        url = `${window.location.origin}/gjs-property-search/properties.json`;
        console.log('Fetching properties.json from', url);
        const res = await fetch(url, { cache: 'no-store' });
        console.log('Properties fetch status:', res.status);
        if (!res.ok) throw new Error(`Fetch failed (${res.status}) for ${url}`);
        const data = await res.json();
        console.log('Loaded properties:', Array.isArray(data) ? data.length : 0);
        console.log('First property:', Array.isArray(data) ? data[0] : null);

        if (!Array.isArray(data)) throw new Error('properties.json is not an array');

        allProperties = data;

        populateTypeOptions(allProperties);

        // initial map markers (static)
        setMapMarkers(allProperties);

        // initial render (no filters applied)
        renderResults(allProperties);

      } catch(err){
        console.error(err);
        statusText.textContent = 'Could not load properties. Check console + file path.';
        document.getElementById('results').innerHTML = `
          <div class="empty">
            <strong>Could not load properties.</strong><br/>
            Failed to load <code>${escapeHtml(url)}</code>.
          </div>
        `;
      }
    }

    // ---------- Wire up ----------
    document.addEventListener('DOMContentLoaded', () => {
      initMap();

      document.getElementById('searchBtn').addEventListener('click', applyFilters);
      document.getElementById('sort').addEventListener('change', applyFilters);

      // Optional: quick UX — enter triggers search
      document.getElementById('q').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') applyFilters();
      });

      loadProperties();
    });
  </script>
</body>
</html>
