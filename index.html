<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root{
      --radius: 12px;
      --gap: 16px;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --border: 1px solid #e7e7e7;
      --text: #111;
      --muted: #666;
      --bg: #fff;
    }
    input[type="number"]{ -moz-appearance: textfield; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }

    body{
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: #fff;
    }
    .wrap{ max-width: 1200px; margin: 0 auto; padding: 12px 18px 60px; }

    .bleed{
      width: 100vw;
      position: relative;
      left: 50%;
      right: 50%;
      margin-left: -50vw;
      margin-right: -50vw;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      margin-bottom: 18px;
    }
    #map{
      height: 420px;
      outline: 1px solid #e8e8e8;
      position: relative;
      z-index: 0;
    }
    @media (max-width: 1100px){ #map{ height: 360px; } }
    @media (max-width: 700px){  #map{ height: 300px; } }

    .searchBar{
      display: grid;
      grid-template-columns:
        minmax(220px, 1.6fr)
        minmax(120px, 1fr)
        minmax(120px, 1fr)
        minmax(120px, 1fr)
        minmax(120px, 1fr)
        minmax(120px, 1fr)
        140px;
      gap: 12px;
      padding: 14px;
      border: var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
      align-items: end;
      position: relative;
      z-index: 1;
      margin-bottom: 14px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .field input, .field select{
      width: 100%;
      height: 44px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #dcdcdc;
      font-size: 14px;
      background: #fff;
    }
    .btn{
      height: 44px;
      padding: 12px 16px;
      background: #111;
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
      border: none;
      font-weight: 600;
      width: 140px;
    }
    .meta{ color: var(--muted); margin: 8px 0 12px; }
    .cards{
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
      margin-top: 10px;
      border-top: var(--border);
      padding-top: 16px;
    }
    @media (min-width: 640px){ .cards{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (min-width: 1024px){ .cards{ grid-template-columns: repeat(3, minmax(0,1fr)); } }

    .card{
      display: grid;
      grid-template-rows: auto 1fr auto;
      background: var(--bg);
      border: var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: var(--shadow); }
    .card__media{ position: relative; aspect-ratio: 4/3; background: #eee; }
    .card__media img{ position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    .card__body{ padding: 14px; }
    .card__loc{ color: var(--muted); font-size: 14px; margin-bottom: 6px; }
    .card__title{ font-size: 18px; font-weight: 600; margin: 0 0 6px; color: var(--text); text-decoration: none; }
    .chip{ display:inline-block; background:#f6f6f6; padding:6px 10px; border-radius:999px; font-size:12px; margin-top:8px; }
    .card__footer{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-top: var(--border); }
    .btn-link, .btn-ghost{ height:36px; padding:0 12px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; font-size:14px; text-decoration:none; }
    .btn-ghost{ border:1px solid #ddd; color:#333; background:#fff; }
    .btn-link{ background:#111; color:#fff; border:none; }
    .btn-link[aria-disabled="true"]{ opacity:.5; pointer-events:none; }
    .empty{ padding: 24px; color: var(--muted); }
  </style>
</head>

<body>
<div class="wrap">
  <div class="bleed"><div id="map"></div></div>

  <div class="searchBar" id="searchForm">
    <div class="field"><label for="q">Location</label><input id="q" placeholder="Town, postcode" /></div>
    <div class="field"><label for="tenure">Tenure</label>
      <select id="tenure">
        <option value="any">Any</option>
        <option value="to let">To Let</option>
        <option value="for sale">For Sale</option>
      </select>
    </div>
    <div class="field"><label for="type">Type</label><select id="type"><option value="any">Any</option></select></div>
    <div class="field"><label for="radius">Radius</label>
      <select id="radius">
        <option value="any">Any</option>
        <option value="1">1 mile</option><option value="3">3 miles</option>
        <option value="5">5 miles</option><option value="10">10 miles</option>
        <option value="25">25 miles</option><option value="50">50 miles</option>
      </select>
    </div>
    <div class="field"><label for="minSize">Min size</label><input id="minSize" type="number" /></div>
    <div class="field"><label for="maxSize">Max size</label><input id="maxSize" type="number" /></div>
    <button class="btn" id="searchBtn" type="button">Search</button>
  </div>

  <div class="meta" id="statusText">Loading properties…</div>
  <div class="meta" id="resultsCount"></div>
  <div class="cards" id="results"></div>
</div>

<script>
let allProperties = [];
let map, markers;

function getPrimaryImage(p){
  if (!p) return '';
  if (Array.isArray(p.images) && p.images[0]) return typeof p.images[0] === 'string' ? p.images[0] : (p.images[0].url || '');
  return p.image || p.image_url || '';
}

async function geocodePlace(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=gb&q=${encodeURIComponent(q)}`;
  const r = await fetch(url, { headers: { 'Accept-Language': 'en' }});
  const j = await r.json();
  if (!Array.isArray(j) || !j[0]) return null;
  return { lat: Number(j[0].lat), lon: Number(j[0].lon), label: j[0].display_name };
}

function haversine(lat1, lon1, lat2, lon2){
  const R = 6371e3; const toRad = d => d * Math.PI/180;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δφ = toRad(lat2-lat1); const Δλ = toRad(lon2-lon1);
  const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function sortByDistance(list, point){
  return list.map(p=>{
    const lat=Number(p.lat), lon=Number(p.lon);
    const d=isFinite(lat)&&isFinite(lon)?haversine(point.lat,point.lon,lat,lon):Infinity;
    return {...p,__distance:d};
  }).sort((a,b)=>a.__distance-b.__distance);
}

function milesToMeters(mi){return mi*1609.344;}

function initMap(){
  map=L.map('map').setView([52.5,-1.8],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  markers=L.layerGroup().addTo(map);
}

function render(list){
  const el=document.getElementById('results');
  document.getElementById('resultsCount').textContent=`${list.length} Properties Found`;
  const status=document.getElementById('statusText');
  status.textContent=list.length?'':'No properties match your filters.';

  if(!list.length){
    el.innerHTML='<div class="empty">No properties match your filters.</div>';
    window._gjsSendHeight?.();
    return;
  }

  el.innerHTML=list.map(p=>{
    const img=getPrimaryImage(p);
    const brochure=p.brochure||p.brochure_url||'';
    const tenureChip=p.to_let?'<span class="chip">To Let</span>':p.for_sale?'<span class="chip">For Sale</span>':'';
    return `<article class="card">
      <div class="card__media">${img?`<img src="${img}" alt="${p.address||'Property'}" loading="lazy">`:''}</div>
      <div class="card__body">
        <div class="card__loc">${[p.town,p.postcode].filter(Boolean).join(' ')}</div>
        <a class="card__title" href="property.html?id=${encodeURIComponent(p.id)}">${p.address||'Property'}</a>
        ${tenureChip}
      </div>
      <div class="card__footer">
        <a class="btn-ghost" href="property.html?id=${encodeURIComponent(p.id)}">View property</a>
        ${brochure?`<a class="btn-link" href="${brochure}" target="_blank" rel="noopener">View brochure</a>`:`<a class="btn-link" aria-disabled="true">No brochure</a>`}
      </div></article>`;
  }).join('');

  window._gjsSendHeight?.();
}

async function applyFilters(){
  const status=document.getElementById('statusText');
  status.textContent='Loading properties…';

  const q=document.getElementById('q').value.trim();
  const tenure=document.getElementById('tenure').value;
  const type=document.getElementById('type').value;
  const radiusVal=document.getElementById('radius').value;

  try{
    let base=allProperties.filter(p=>{
      if(tenure!=='any'){
        if(tenure.toLowerCase()==='to let'&&!p.to_let)return false;
        if(tenure.toLowerCase()==='for sale'&&!p.for_sale)return false;
      }
      if(type!=='any'){
        const ty=(p.type||p.property_type||(Array.isArray(p.types)?p.types.join(' '):'')).toLowerCase();
        if(!ty.includes(type.toLowerCase()))return false;
      }
      return true;
    });

    if(!q){ render(base); status.textContent=''; return; }

    const point=await geocodePlace(q);
    if(!point){ render(base); status.textContent=''; return; }

    let finalList=sortByDistance(base,point);
    if(radiusVal!=='any'){
      const meterLimit=milesToMeters(Number(radiusVal));
      finalList=finalList.filter(p=>p.__distance<=meterLimit);
    }

    render(finalList);
    status.textContent='';
  }catch(e){
    console.error(e);
    status.textContent='Error applying filters.';
  }
}

async function loadProperties(){
  try{
    document.getElementById('statusText').textContent='Loading properties…';
    const res=await fetch('./properties.json',{cache:'no-store'});
    const raw=await res.json();
    allProperties=raw;
    const types=new Set();
    allProperties.forEach(p=>{
      const t=(p.type||p.property_type||(Array.isArray(p.types)?p.types[0]:'')||'').trim();
      if(t)types.add(t);
    });
    const typeSel=document.getElementById('type');
    typeSel.innerHTML='<option value="any">Any</option>'+[...types].sort().map(t=>`<option>${t}</option>`).join('');
    document.getElementById('statusText').textContent='';
    applyFilters();
  }catch(e){
    document.getElementById('statusText').textContent='Failed to load properties.json';
    console.error(e);
  }
}

document.addEventListener('DOMContentLoaded',()=>{
  initMap();
  document.getElementById('searchBtn').onclick=applyFilters;
  document.getElementById('q').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();applyFilters();}});
  loadProperties();
});
</script>
</body>
</html>
