<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* (your CSS remains unchanged, trimmed here for brevity) */
  </style>
</head>

<body>
<div class="wrap">
  <div class="bleed">
    <div id="map"></div>
  </div>

  <div class="searchBar" id="searchForm">
    <div class="field">
      <label for="q">Location</label>
      <input id="q" placeholder="Town, postcode" />
    </div>

    <div class="field">
      <label for="tenure">Tenure</label>
      <select id="tenure">
        <option value="any">Any</option>
        <option value="to let">To Let</option>
        <option value="for sale">For Sale</option>
      </select>
    </div>

    <div class="field">
      <label for="type">Type</label>
      <select id="type"><option value="any">Any</option></select>
    </div>

    <div class="field">
      <label for="radius">Radius</label>
      <select id="radius" title="Search radius from location">
        <option value="any">Any</option>
        <option value="1">1 mile</option>
        <option value="3">3 miles</option>
        <option value="5">5 miles</option>
        <option value="10">10 miles</option>
        <option value="25">25 miles</option>
        <option value="50">50 miles</option>
      </select>
    </div>

    <div class="field"><label for="minSize">Min size</label><input id="minSize" type="number" inputmode="numeric" /></div>
    <div class="field"><label for="maxSize">Max size</label><input id="maxSize" type="number" inputmode="numeric" /></div>

    <button class="btn" id="searchBtn" type="button">Search</button>
  </div>

  <div class="meta" id="statusText">Loading properties…</div>
  <div class="meta" id="resultsCount"></div>
  <div class="cards" id="results"></div>
</div>

<script>
let allProperties = [];
let map, markers, searchMarker;

const MAPBOX_TOKEN = "";

function getPrimaryImage(p){
  if (!p) return '';
  if (Array.isArray(p.images) && p.images[0]) {
    const img = p.images[0];
    if (typeof img === 'string') return img;
    if (img._) return img._;
    if (img.url) return img.url;
  }
  if (Array.isArray(p.photos) && p.photos[0]?.url) return p.photos[0].url;
  return p.image || p.image_url || '';
}

async function geocodePlace(q){
  const query = q.trim();
  if (!query) return null;
  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=gb&q=${encodeURIComponent(query)}`;
    const r = await fetch(url, { headers: { 'Accept-Language': 'en' }});
    const j = await r.json();
    if (!Array.isArray(j) || !j[0]) return null;
    return { lat: Number(j[0].lat), lon: Number(j[0].lon), label: j[0].display_name };
  } catch (e) {
    console.warn('Geocode failed:', e);
    return null;
  }
}

function haversine(lat1, lon1, lat2, lon2){
  const R = 6371e3; const toRad = d => d * Math.PI/180;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δφ = toRad(lat2-lat1); const Δλ = toRad(lon2-lon1);
  const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function sortByDistance(list, point){
  return list.map(p => {
    const lat = Number(p.lat), lon = Number(p.lon);
    const d = (isFinite(lat) && isFinite(lon)) ? haversine(point.lat, point.lon, lat, lon) : Number.POSITIVE_INFINITY;
    return { ...p, __distance: d };
  }).sort((a,b) => a.__distance - b.__distance);
}

function milesToMeters(mi){ return mi * 1609.344; }

function initMap(){
  map = L.map('map').setView([52.5, -1.8], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  markers = L.layerGroup().addTo(map);
  searchMarker = L.layerGroup().addTo(map);
}

function updateMap(list, focusPoint){
  markers.clearLayers();
  searchMarker.clearLayers();
  const points = [];
  list.forEach(p => {
    const lat = Number(p.lat), lon = Number(p.lon);
    if (!isFinite(lat) || !isFinite(lon)) return;
    const marker = L.circleMarker([lat, lon], { radius:7, weight:2, color:'#111', fillColor:'#111', fillOpacity:0.85 }).addTo(markers);
    points.push([lat, lon]);
  });
  if (focusPoint && isFinite(focusPoint.lat) && isFinite(focusPoint.lon)) {
    const sp = L.circleMarker([focusPoint.lat, focusPoint.lon], { radius:10, weight:3, color:'#2563eb', fillColor:'#2563eb', fillOpacity:0.75 }).addTo(searchMarker);
    sp.bindTooltip(focusPoint.label || 'Search location', { direction:'top', offset:[0,-12] });
    points.push([focusPoint.lat, focusPoint.lon]);
  }
  if (!points.length) return;
  const MAX_SEARCH_ZOOM = 11, PADDING = [60,60];
  if (points.length === 1) map.setView(points[0], MAX_SEARCH_ZOOM);
  else map.fitBounds(points, { padding:PADDING, maxZoom:MAX_SEARCH_ZOOM });
}

function render(list, context = {}){
  const el = document.getElementById('results');
  document.getElementById('resultsCount').textContent = `${list.length} Properties Found`;
  document.getElementById('statusText').textContent = '';
  if (!list.length){ el.innerHTML = `<div class="empty">No properties match your filters.</div>`; return; }
  el.innerHTML = list.map(p => {
    const img = getPrimaryImage(p);
    const brochure = p.brochure || p.brochure_url || '';
    const chip = p.to_let ? `<span class="chip">To Let</span>` : p.for_sale ? `<span class="chip">For Sale</span>` : '';
    return `<article class="card">
      <div class="card__media">${img ? `<img src="${img}" alt="${p.address||'Property'}" loading="lazy">` : ''}</div>
      <div class="card__body">
        <div class="card__loc">${[p.town,p.postcode].filter(Boolean).join(' ')}</div>
        <a class="card__title" href="property.html?id=${encodeURIComponent(p.id??'')}">${p.address||'Property'}</a>
        ${chip}
      </div>
      <div class="card__footer">
        <a class="btn-ghost" href="property.html?id=${encodeURIComponent(p.id??'')}">View property</a>
        ${brochure ? `<a class="btn-link" href="${brochure}" target="_blank" rel="noopener">View brochure</a>` : `<a class="btn-link" aria-disabled="true">No brochure</a>`}
      </div></article>`;
  }).join('');
}

async function applyFilters(){
  const status=document.getElementById('statusText');
  status.textContent='Loading properties…';
  const q=document.getElementById('q').value.trim();
  const tenure=document.getElementById('tenure').value;
  const type=document.getElementById('type').value;
  const radiusVal=document.getElementById('radius').value;

  try {
    let base=allProperties.filter(p=>{
      if(tenure!=='any'){
        if(tenure.toLowerCase()==='to let'&&!p.to_let)return false;
        if(tenure.toLowerCase()==='for sale'&&!p.for_sale)return false;
      }
      if(type!=='any'){
        const ty=(p.type||p.property_type||'').toLowerCase();
        if(!ty.includes(type.toLowerCase()))return false;
      }
      return true;
    });

    if(!q){ render(base); updateMap(base); status.textContent=''; return; }

    const point=await geocodePlace(q);
    if(!point){ render(base); updateMap(base); status.textContent=''; return; }

    let finalList=sortByDistance(base,point);
    if(radiusVal!=='any'){
      const meterLimit=milesToMeters(Number(radiusVal));
      finalList=finalList.filter(p=>p.__distance<=meterLimit);
    }

    render(finalList);
    updateMap(finalList, point);  // ✅ ensures map zooms to search
    status.textContent='';
  } catch(e){
    console.error(e);
    status.textContent='Error applying filters.';
  }
}

async function loadProperties(){
  try {
    document.getElementById('statusText').textContent='Loading properties…';
    const res=await fetch('./properties.json',{cache:'no-store'});
    const raw=await res.json();
    allProperties=raw.map((p,i)=>({id:p.id??i,...p}));
    const types=new Set();
    allProperties.forEach(p=>{const t=(p.type||p.property_type||(Array.isArray(p.types)?p.types[0]:'')||'').trim();if(t)types.add(t);});
    const typeSel=document.getElementById('type');
    typeSel.innerHTML='<option value="any">Any</option>'+[...types].sort().map(t=>`<option>${t}</option>`).join('');
    document.getElementById('statusText').textContent='';
    applyFilters();
  } catch(e){
    document.getElementById('statusText').textContent='Failed to load properties.json';
    console.error(e);
  }
}

document.addEventListener('DOMContentLoaded',()=>{
  initMap();
  document.getElementById('searchBtn').onclick=applyFilters;
  document.getElementById('q').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();applyFilters();}});
  loadProperties();
});
</script>
</body>
</html>
