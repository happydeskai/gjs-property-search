<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #fff;
      color: #111;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    h1 {
      margin: 0 0 16px;
      font-size: 34px;
    }

    #map {
      height: clamp(260px, 42vw, 360px);
      border-radius: 14px;
      margin-bottom: 18px;
      overflow: hidden;
      position: relative;
      z-index: 0;
    }

    .searchBar {
      display: grid;
      grid-template-columns: 1fr;
      grid-template-areas:
        "location"
        "tenure"
        "type"
        "min"
        "max"
        "submit";
      gap: 12px;
      padding: 16px;
      border: 1px solid #ededed;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      align-items: end;
      position: relative;
      z-index: 1;
    }

    .field {
      min-width: 0;
    }

    .field label {
      font-size: 12px;
      color: #666;
      display: block;
      margin-bottom: 6px;
    }

    .field-hint {
      font-size: 11px;
      color: #8a8a8a;
      margin-top: 6px;
    }

    .field input,
    .field select {
      width: 100%;
      height: 44px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #dcdcdc;
      font-size: 14px;
      background: #fff;
    }

    .field input:focus-visible,
    .field select:focus-visible,
    .btn:focus-visible {
      outline: 2px solid #111;
      outline-offset: 2px;
    }

    .btn {
      width: 100%;
      height: 44px;
      padding: 12px 16px;
      background: #111;
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    .field--location {
      grid-area: location;
    }

    .field--tenure {
      grid-area: tenure;
    }

    .field--type {
      grid-area: type;
    }

    .field--min {
      grid-area: min;
    }

    .field--max {
      grid-area: max;
    }

    .searchBar__submit {
      grid-area: submit;
      align-self: end;
    }

    @media (min-width: 641px) {
      .searchBar {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-template-areas:
          "location tenure"
          "type min"
          "max submit";
      }
    }

    @media (min-width: 900px) {
      .searchBar {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        grid-template-areas:
          "location tenure type"
          "min max submit";
      }
    }

    @media (min-width: 1024px) {
      .searchBar {
        grid-template-columns: repeat(6, minmax(0, 1fr));
        grid-template-areas: "location tenure type min max submit";
      }
    }

    .meta {
      color: #666;
      margin-bottom: 12px;
    }

    .cards {
      border-top: 1px solid #eaeaea;
    }

    .card {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 16px;
      padding: 18px 6px;
      border-bottom: 1px solid #eaeaea;
    }

    .thumb {
      width: 180px;
      height: 120px;
      border-radius: 12px;
      overflow: hidden;
      background: #eee;
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chip {
      display: inline-block;
      background: #f6f6f6;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      margin-right: 6px;
      margin-top: 6px;
    }

    .links a {
      margin-right: 12px;
      color: #111;
      text-decoration: underline;
      font-size: 14px;
    }

    .empty {
      padding: 24px;
      color: #666;
    }

  </style>
</head>

<body>
<div class="wrap">
  <h1>Property Search</h1>

  <!-- MAP ABOVE SEARCH -->
  <div id="map"></div>

  <form class="searchBar" id="searchForm">
    <div class="field field--location">
      <label for="q">Location</label>
      <input id="q" placeholder="Town, postcode" aria-describedby="q-hint" />
      <div class="field-hint" id="q-hint">Search by town, postcode, or address.</div>
    </div>

    <div class="field field--tenure">
      <label for="tenure">Tenure</label>
      <select id="tenure" aria-describedby="tenure-hint">
        <option value="any">Any</option>
        <option value="to let">To Let</option>
        <option value="for sale">For Sale</option>
      </select>
      <div class="field-hint" id="tenure-hint">Filter by transaction type.</div>
    </div>

    <div class="field field--type">
      <label for="type">Type</label>
      <select id="type" aria-describedby="type-hint">
        <option value="any">Any</option>
      </select>
      <div class="field-hint" id="type-hint">Choose a property type if needed.</div>
    </div>

    <div class="field field--min">
      <label for="minSize">Min size</label>
      <input id="minSize" type="number" inputmode="numeric" aria-describedby="minSize-hint" />
      <div class="field-hint" id="minSize-hint">Minimum size in square feet.</div>
    </div>

    <div class="field field--max">
      <label for="maxSize">Max size</label>
      <input id="maxSize" type="number" inputmode="numeric" aria-describedby="maxSize-hint" />
      <div class="field-hint" id="maxSize-hint">Maximum size in square feet.</div>
    </div>

    <button class="btn searchBar__submit" id="searchBtn" type="submit">Search</button>
  </form>

  <div class="meta" id="statusText">Loading properties…</div>
  <div class="meta" id="resultsCount"></div>
  <div class="cards" id="results"></div>
</div>

<script>
let allProperties = [];
let map, markers;

// ---------- IMAGE HANDLER ----------
function getPrimaryImage(p){
  if (!p) return '';
  if (Array.isArray(p.images) && p.images[0]) {
    const img = p.images[0];
    if (typeof img === 'string') return img;
    if (img._) return img._;
    if (img.url) return img.url;
  }
  if (Array.isArray(p.photos) && p.photos[0]?.url) return p.photos[0].url;
  return p.image || p.image_url || '';
}

// ---------- MAP ----------
function initMap(){
  map = L.map('map').setView([52.5, -1.8], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  markers = L.layerGroup().addTo(map);
}

// ---------- FILTER + RENDER ----------
function applyFilters(){
  const q = document.getElementById('q').value.toLowerCase();
  const tenure = document.getElementById('tenure').value;

  const filtered = allProperties.filter(p => {
    const text = `${p.address||''} ${p.town||''} ${p.postcode||''}`.toLowerCase();
    if (q && !text.includes(q)) return false;

    if (tenure !== 'any') {
      const t = (p.tenure || p.transaction_type || '').toLowerCase();
      if (!t.includes(tenure)) return false;
    }
    return true;
  });

  render(filtered);
  updateMap(filtered);
}

function render(list){
  document.getElementById('resultsCount').textContent =
    `${list.length} Properties Found`;
  document.getElementById('statusText').textContent =
    `Showing ${list.length} of ${allProperties.length}`;

  const el = document.getElementById('results');

  if (!list.length){
    el.innerHTML = `<div class="empty">No properties match your filters.</div>`;
    return;
  }

  el.innerHTML = list.map(p => {
    const img = getPrimaryImage(p);
    const brochure = p.brochure || p.brochure_url || '';
    const size =
      p.size_from_sqft && p.size_to_sqft
        ? `${p.size_from_sqft}–${p.size_to_sqft} sq ft`
        : p.size_from_sqft
        ? `${p.size_from_sqft} sq ft`
        : '';

    return `
      <div class="card">
        <div class="thumb">
          ${img ? `<img src="${img}" />` : ``}
        </div>
        <div>
          <strong>${p.address || 'Property'}</strong><br/>
          ${p.town || ''} ${p.postcode || ''}<br/>
          ${size ? `<small>${size}</small><br/>` : ''}
          ${p.tenure ? `<span class="chip">${p.tenure}</span>` : ''}
          <div class="links">
            ${brochure ? `<a href="${brochure}" target="_blank">View brochure</a>` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function updateMap(list){
  markers.clearLayers();

  if (!list.length) return;

  const points = [];

  list.forEach(p => {
    const lat = Number(p.lat);
    const lon = Number(p.lon);
    if (!lat || !lon) return;

    const marker = L.circleMarker([lat, lon], {
      radius: 7,
      weight: 2,
      color: '#111',
      fillColor: '#111',
      fillOpacity: 0.85
    });

    marker.bindPopup(`
      <strong>${p.address || 'Property'}</strong><br/>
      ${p.town || ''} ${p.postcode || ''}<br/>
      ${p.size_from_sqft ? `${p.size_from_sqft}–${p.size_to_sqft} sq ft<br/>` : ''}
      ${p.brochure || p.brochure_url ? `<a href="${p.brochure || p.brochure_url}" target="_blank">View brochure</a>` : ''}
    `);

    marker.addTo(markers);
    points.push([lat, lon]);
  });

  // ✅ BETTER ZOOM LOGIC
  if (points.length === 1) {
    map.setView(points[0], 14); // ← zoomed OUT a bit (street / area level)
  } else {
    map.fitBounds(points, { padding: [60, 60] });
  }
}


// ---------- LOAD ----------
async function loadProperties(){
  try {
    const res = await fetch('./properties.json', { cache: 'no-store' });
    allProperties = await res.json();
    applyFilters();
  } catch (e) {
    document.getElementById('statusText').textContent =
      'Failed to load properties.json';
    console.error(e);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initMap();
  document.getElementById('searchForm').addEventListener('submit', (event) => {
    event.preventDefault();
    applyFilters();
  });
  loadProperties();
});
</script>
</body>
</html>
