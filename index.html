<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    :root{
      --text:#111;
      --muted:#666;
      --border:#eaeaea;
      --bg:#fff;
      --chip:#f6f6f6;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:28px 18px 60px; }
    h1{ margin:0 0 16px; font-size:34px; }
    .searchBar{
      display:grid;
      grid-template-columns:1.4fr 1fr 0.9fr 0.9fr 1fr auto;
      gap:12px;
      padding:14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      box-shadow:var(--shadow);
    }
    .field label{ font-size:12px; color:var(--muted); }
    .field input,.field select{
      width:100%; padding:12px;
      border:1px solid #dcdcdc; border-radius:10px;
    }
    .btn{
      padding:12px 16px;
      background:#111; color:#fff;
      border-radius:10px; cursor:pointer;
    }
    #map{
      height:340px;
      border-radius:14px;
      margin:12px 0 22px;
    }
    .cards{ border-top:1px solid var(--border); }
    .card{
      display:grid;
      grid-template-columns:180px 1fr;
      gap:16px;
      padding:18px 6px;
      border-bottom:1px solid var(--border);
    }
    .thumb{ height:120px; background:#eee; border-radius:12px; }
    .empty{ padding:24px; color:var(--muted); }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Property Search</h1>

  <div class="searchBar">
    <div class="field">
      <label>Location</label>
      <input id="q" />
    </div>
    <div class="field">
      <label>Tenure</label>
      <select id="tenure">
        <option value="any">Any</option>
        <option value="to let">To Let</option>
        <option value="for sale">For Sale</option>
      </select>
    </div>
    <div class="field">
      <label>Type</label>
      <select id="type"><option value="any">Any</option></select>
    </div>
    <div class="field">
      <label>Min size</label>
      <input id="minSize" type="number" />
    </div>
    <div class="field">
      <label>Max size</label>
      <input id="maxSize" type="number" />
    </div>
    <button class="btn" id="searchBtn">Search</button>
  </div>

  <p id="statusText">Loading properties…</p>
  <div id="map"></div>
  <p id="resultsCount">0 Properties Found</p>
  <div class="cards" id="results"></div>
</div>

<script>
let allProperties = [];
let map, markers;

function initMap(){
  map = L.map('map').setView([52.5,-1.8],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  markers = L.layerGroup().addTo(map);
}

function applyFilters(){
  const q = document.getElementById('q').value.toLowerCase();
  const tenure = document.getElementById('tenure').value;

  let filtered = allProperties.filter(p => {
    const text = `${p.address||''} ${p.town||''} ${p.postcode||''}`.toLowerCase();
    if (q && !text.includes(q)) return false;

    // ✅ TENURE FILTER (FIX)
    if (tenure !== 'any') {
      const t = (p.tenure || p.transaction_type || '').toLowerCase();
      if (!t.includes(tenure)) return false;
    }

    return true;
  });

  render(filtered);
}

function render(list){
  document.getElementById('resultsCount').textContent =
    `${list.length} Properties Found`;
  document.getElementById('statusText').textContent =
    `Showing ${list.length} of ${allProperties.length}`;

  const el = document.getElementById('results');
  if (!list.length){
    el.innerHTML = `<div class="empty">No properties match your filters.</div>`;
    return;
  }

  el.innerHTML = list.map(p => `
    <div class="card">
      <div class="thumb"></div>
      <div>
        <strong>${p.address || 'Property'}</strong><br/>
        ${p.town || ''} ${p.postcode || ''}
      </div>
    </div>
  `).join('');
}

async function loadProperties(){
  try{
    const res = await fetch('./properties.json', { cache:'no-store' });
    const data = await res.json();
    allProperties = data;
    applyFilters();
  }catch(e){
    document.getElementById('statusText').textContent =
      'Could not load properties.json';
    console.error(e);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initMap();
  document.getElementById('searchBtn').onclick = applyFilters;
  loadProperties();
});
</script>
</body>
</html>
