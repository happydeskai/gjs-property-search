<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ---- base & reset ---- */
    *, *::before, *::after { box-sizing: border-box; }
    :root{
      --radius: 12px;
      --gap: 16px;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --border: 1px solid #e7e7e7;
      --text: #111;
      --muted: #666;
      --bg: #fff;
    }
    input[type="number"]{ -moz-appearance: textfield; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }

    body{
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: #fff;
    }
    .wrap{ max-width: 1200px; margin: 0 auto; padding: 12px 18px 60px; }

    /* ---- full-bleed map ---- */
    .bleed{
      width: 100vw;
      position: relative;
      left: 50%;
      right: 50%;
      margin-left: -50vw;
      margin-right: -50vw;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      margin-bottom: 18px;
    }
    #map{
      height: 420px;
      outline: 1px solid #e8e8e8;
      position: relative;
      z-index: 0;
    }
    @media (max-width: 1100px){ #map{ height: 360px; } }
    @media (max-width: 700px){  #map{ height: 300px; } }

    /* ---- search bar ---- */
    .searchBar{
      display: grid;
      grid-template-columns:
        minmax(220px, 1.6fr)
        minmax(120px, 1fr)
        minmax(120px, 1fr)
        minmax(120px, 1fr)
        minmax(120px, 1fr)
        minmax(120px, 1fr)
        140px;
      gap: 12px;
      padding: 14px;
      border: var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
      align-items: end;
      position: relative;
      z-index: 1;
      margin-bottom: 14px;
    }

    .field{
      min-width: 0;
      display: grid;
      grid-template-rows: auto 44px auto;
      align-content: start;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .field input, .field select{
      width: 100%;
      height: 44px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #dcdcdc;
      font-size: 14px;
      background: #fff;
      align-self: end;
    }
    .btn{
      height: 44px;
      padding: 12px 16px;
      background: #111;
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
      border: none;
      font-weight: 600;
      width: 140px;
      align-self: end;
    }
    .field input:focus-visible,
    .field select:focus-visible,
    .btn:focus-visible{
      outline: 2px solid #111;
      outline-offset: 2px;
    }

    .meta{ color: var(--muted); margin: 8px 0 12px; }

    /* ---- results grid ---- */
    .cards{
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
      margin-top: 10px;
      border-top: var(--border);
      padding-top: 16px;
    }
    @media (min-width: 640px){
      .cards{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (min-width: 1024px){
      .cards{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    /* ---- card ---- */
    .card{
      display: grid;
      grid-template-rows: auto 1fr auto;
      background: var(--bg);
      border: var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: var(--shadow); }

    .card__media{ position: relative; aspect-ratio: 4 / 3; background: #eee; }
    .card__media img{
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }

    .card__body{ padding: 14px; }
    .card__loc{ color: var(--muted); font-size: 14px; margin-bottom: 6px; }
    .card__title{ font-size: 18px; font-weight: 600; margin: 0 0 6px; color: var(--text); text-decoration: none; }
    .card__meta{ color: var(--muted); font-size: 14px; margin-top: 6px; }
    .chip{ display:inline-block; background:#f6f6f6; padding:6px 10px; border-radius:999px; font-size:12px; margin-top:8px; }

    .card__footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-top: var(--border);
    }

    .btn-link, .btn-ghost{
      height:36px;
      padding:0 12px;
      border-radius:8px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      text-decoration:none;
    }
    .btn-ghost{ border:1px solid #ddd; color:#333; background:#fff; }
    .btn-link{ background:#111; color:#fff; border:none; }
    .btn-link[aria-disabled="true"]{ opacity:.5; pointer-events:none; }

    .empty{ padding: 24px; color: var(--muted); }

    /* ---- Map popup card ---- */
    .prop-popup .leaflet-popup-content { margin: 0 !important; }
    .prop-popup .leaflet-popup-content-wrapper {
      padding: 0;
      border-radius: 12px;
      overflow: hidden;
    }
    .prop-popup .leaflet-popup-tip { display: none; }

    .pop-card { width: 320px; background: #fff; }
    .pop-img  { width: 100%; height: 160px; background-size: cover; background-position: center; background-color: #eee; }
    .pop-body { padding: 12px 14px; }
    .pop-title{ font-weight: 700; margin: 0 0 4px; }
    .pop-sub  { color: #6b7280; font-size: 13px; margin-bottom: 4px; }
    .pop-size { font-size: 13px; margin-bottom: 10px; }
    .pop-btn  {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 8px;
      background:#111;
      color:#fff;
      text-decoration:none;
      font-weight:600;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="bleed">
    <div id="map"></div>
  </div>

  <div class="searchBar" id="searchForm">
    <div class="field">
      <label for="q">Location</label>
      <input id="q" placeholder="Town, postcode" />
    </div>

    <div class="field">
      <label for="tenure">Tenure</label>
      <select id="tenure">
        <option value="any">Any</option>
        <option value="to let">To Let</option>
        <option value="for sale">For Sale</option>
      </select>
    </div>

    <div class="field">
      <label for="type">Type</label>
      <select id="type">
        <option value="any">Any</option>
      </select>
    </div>

    <div class="field">
      <label for="radius">Radius</label>
      <select id="radius">
        <option value="any">Any</option>
        <option value="1">1 mile</option>
        <option value="3">3 miles</option>
        <option value="5">5 miles</option>
        <option value="10">10 miles</option>
        <option value="15">15 miles</option>
        <option value="25">25 miles</option>
        <option value="50">50 miles</option>
      </select>
    </div>

    <div class="field">
      <label for="minSize">Min size</label>
      <input id="minSize" type="number" />
    </div>

    <div class="field">
      <label for="maxSize">Max size</label>
      <input id="maxSize" type="number" />
    </div>

    <button class="btn" id="searchBtn" type="button">Search</button>
  </div>

  <div class="meta" id="statusText">Loading properties…</div>
  <div class="meta" id="resultsCount"></div>
  <div class="cards" id="results"></div>
</div>

<script>
/* ================= FIX IS BELOW ================= */

let allProperties = [];
let map, markers, searchMarker;

/* ---------- GEO HELPERS ---------- */
function haversine(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const toRad = d => d * Math.PI/180;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δφ = toRad(lat2-lat1), Δλ = toRad(lon2-lon1);
  const a = Math.sin(Δφ/2)**2 +
            Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function sortByDistance(list, point){
  return list
    .map(p => ({
      ...p,
      __distance: isFinite(p.lat) && isFinite(p.lon)
        ? haversine(point.lat, point.lon, p.lat, p.lon)
        : Infinity
    }))
    .sort((a,b)=>a.__distance - b.__distance);
}

async function geocodePlace(q){
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=gb&q=${encodeURIComponent(q)}`);
  const j = await r.json();
  return j[0] ? { lat:+j[0].lat, lon:+j[0].lon, label:j[0].display_name } : null;
}

/* ---------- FILTER FLOW ---------- */
async function applyFilters(){
  const q = document.getElementById('q').value.trim();
  const radiusVal = document.getElementById('radius').value;

  let list = [...allProperties];

  if (q){
    const point = await geocodePlace(q);
    if (point){
      list = sortByDistance(list, point);

      if (radiusVal !== 'any'){
        const limit = radiusVal * 1609.344;
        list = list.filter(p => p.__distance <= limit);
      }
    }
  }

  render(list);
}

/* ---------- RENDER ---------- */
function render(list){
  document.getElementById('resultsCount').textContent =
    `${list.length} Properties Found`;

  document.getElementById('results').innerHTML =
    list.map(p=>`
      <article class="card">
        <div class="card__body">
          <div class="card__loc">${p.town || ''}</div>
          <div class="card__title">${p.address || 'Property'}</div>
          ${p.__distance != null ? `<div class="chip">${(p.__distance/1000).toFixed(1)} km</div>` : ''}
        </div>
      </article>
    `).join('');
}

/* ---------- LOAD ---------- */
async function load(){
  const r = await fetch('./properties.json');
  allProperties = await r.json();
  applyFilters();
}

document.getElementById('searchBtn').onclick = applyFilters;
load();
</script>
</body>
</html>
